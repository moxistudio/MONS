<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MONS - ÊûÅÁÆÄËÆæËÆ°</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230D0D0D' width='100' height='100' rx='18'/><text x='50' y='68' text-anchor='middle' fill='white' font-size='45' font-weight='bold' font-family='Georgia,serif'>M</text></svg>">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0D0D0D;
            --bg-secondary: #1A1A1A;
            --bg-tertiary: #252525;
            --bg-workspace: #2a2a2a;
            --bg-card: rgba(30,30,30,0.95);
            --border-subtle: rgba(255,255,255,0.08);
            --border-medium: rgba(255,255,255,0.15);
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255,255,255,0.7);
            --text-muted: rgba(255,255,255,0.45);
            --accent: #4A90D9;
            --accent-hover: #5BA0E9;
            --success: #34C759;
            --error: #FF3B30;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --font-sans: 'Noto Sans SC', -apple-system, sans-serif;
            --font-serif: 'Noto Serif SC', Georgia, serif;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; position: fixed; width: 100%; }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-sans);
            display: flex;
            flex-direction: column;
            padding-top: var(--safe-top);
        }

        .loading-screen {
            position: fixed; inset: 0; background: var(--bg-primary);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999; transition: opacity 0.4s;
        }
        .loading-screen.hide { opacity: 0; pointer-events: none; }
        .loading-logo { font-size: 36px; font-weight: 700; letter-spacing: 10px; }

        .header {
            height: 52px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-subtle);
            display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0; z-index: 100;
        }
        .brand { font-size: 17px; font-weight: 600; letter-spacing: 5px; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        
        .btn {
            background: transparent; color: var(--text-secondary); border: 1px solid var(--border-medium);
            padding: 0 16px; height: 38px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 500;
            cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 8px;
        }
        .btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--accent); color: white; border: none; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-icon { width: 38px; height: 38px; padding: 0; justify-content: center; border-radius: 50%; font-size: 14px; }

        .scene-bar {
            display: flex; gap: 10px; padding: 12px 16px; background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle); overflow-x: auto; flex-shrink: 0;
        }
        .scene-bar::-webkit-scrollbar { display: none; }
        .scene-btn {
            flex-shrink: 0; padding: 10px 18px; background: var(--bg-tertiary); border: none;
            border-radius: 100px; color: var(--text-secondary); font-size: 13px; font-weight: 500;
            cursor: pointer; transition: all 0.15s;
        }
        .scene-btn:hover { background: var(--border-medium); }
        .scene-btn.active { background: var(--accent); color: white; }

        .workspace {
            flex: 1; position: relative; overflow: hidden;
            background: var(--bg-workspace);
            background-image: 
                linear-gradient(45deg, rgba(255,255,255,0.015) 25%, transparent 25%),
                linear-gradient(-45deg, rgba(255,255,255,0.015) 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, rgba(255,255,255,0.015) 75%),
                linear-gradient(-45deg, transparent 75%, rgba(255,255,255,0.015) 75%);
            background-size: 24px 24px;
        }
        
        .workspace.tool-hand { cursor: grab; }
        .workspace.tool-hand.dragging { cursor: grabbing; }
        .workspace.tool-select { cursor: default; }
        .workspace.tool-add { cursor: crosshair; }

        .canvas-box {
            position: absolute;
            box-shadow: 0 12px 48px rgba(0,0,0,0.5);
        }
        
        .workspace.tool-hand .canvas-box,
        .workspace.tool-add .canvas-box { pointer-events: none; }

        .zoom-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--bg-card); backdrop-filter: blur(16px);
            border: 1px solid var(--border-medium); border-radius: 100px;
            padding: 5px 14px; display: flex; align-items: center; gap: 6px; z-index: 60;
        }
        .zoom-btn {
            width: 32px; height: 32px; border-radius: 50%; background: transparent; border: none;
            color: var(--text-secondary); font-size: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.15s;
        }
        .zoom-btn:hover { background: var(--bg-tertiary); color: var(--accent); }
        .zoom-btn:active { transform: scale(0.9); }
        .zoom-val {
            min-width: 48px; text-align: center; font-size: 12px; color: var(--text-secondary);
            cursor: pointer; padding: 6px; border-radius: 6px;
        }
        .zoom-val:hover { background: var(--bg-tertiary); }
        .zoom-sep { width: 1px; height: 20px; background: var(--border-medium); }

        .smart-toolbar {
            position: fixed; bottom: calc(90px + var(--safe-bottom)); left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--bg-card); backdrop-filter: blur(16px);
            border: 1px solid var(--border-medium); border-radius: 14px;
            padding: 8px 12px; display: flex; align-items: center; gap: 4px; z-index: 95;
            opacity: 0; pointer-events: none; transition: all 0.2s;
        }
        .smart-toolbar.show { transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: auto; }
        
        .tool-btn {
            min-width: 38px; height: 38px; border-radius: 8px; background: transparent; border: none;
            color: var(--text-secondary); font-size: 14px; cursor: pointer; transition: all 0.15s;
            display: flex; align-items: center; justify-content: center;
        }
        .tool-btn:hover { background: var(--bg-tertiary); color: var(--accent); }
        .tool-btn:active { transform: scale(0.92); }
        .tool-btn.danger:hover { background: rgba(255,59,48,0.15); color: var(--error); }
        .tool-sep { width: 1px; height: 24px; background: var(--border-medium); margin: 0 4px; }

        .font-sel { background: var(--bg-tertiary); border: 1px solid var(--border-subtle); color: var(--text-primary); padding: 0 8px; height: 32px; border-radius: 6px; font-size: 11px; }
        .size-box { display: flex; align-items: center; background: var(--bg-tertiary); border-radius: 6px; padding: 2px; }
        .size-btn { width: 24px; height: 24px; border-radius: 4px; background: transparent; border: none; color: var(--text-secondary); font-size: 12px; cursor: pointer; }
        .size-btn:hover { background: var(--bg-secondary); }
        .size-val { min-width: 32px; text-align: center; font-size: 11px; color: var(--text-primary); cursor: pointer; }

        .color-row { display: flex; gap: 4px; margin-left: 6px; }
        .color-dot {
            width: 22px; height: 22px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent; transition: all 0.15s;
        }
        .color-dot:hover { transform: scale(1.15); }
        .color-dot.sel { border-color: white; }
        .color-dot.picker { background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); }

        .dock {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-card); backdrop-filter: blur(16px);
            border-top: 1px solid var(--border-subtle);
            padding: 8px 16px; padding-bottom: calc(8px + var(--safe-bottom));
            display: flex; justify-content: center; gap: 6px; z-index: 90;
        }
        .dock-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            padding: 10px 18px; border-radius: var(--radius-md); cursor: pointer;
            color: var(--text-muted); transition: all 0.15s; position: relative;
        }
        .dock-item:hover { background: var(--bg-tertiary); color: var(--text-secondary); }
        .dock-item:active { transform: scale(0.95); }
        .dock-item.active { color: var(--accent); background: rgba(74,144,217,0.15); }
        .dock-item i { font-size: 20px; }
        .dock-item span { font-size: 10px; font-weight: 500; }

        .add-popup {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: var(--bg-card); backdrop-filter: blur(16px);
            border: 1px solid var(--border-medium); border-radius: var(--radius-md);
            padding: 6px; margin-bottom: 10px; display: none; flex-direction: column; gap: 2px;
            min-width: 110px;
        }
        .add-popup.show { display: flex; }
        .add-item {
            display: flex; align-items: center; gap: 10px; padding: 10px 14px;
            border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary);
            transition: all 0.15s; font-size: 13px;
        }
        .add-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .add-item i { width: 18px; text-align: center; }

        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 140;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .overlay.show { opacity: 1; pointer-events: auto; }

        .panel {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-secondary); border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            z-index: 150; transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 65vh; display: flex; flex-direction: column;
        }
        .panel.show { transform: translateY(0); }
        .panel-head {
            padding: 16px 20px; border-bottom: 1px solid var(--border-subtle);
            display: flex; justify-content: space-between; align-items: center;
        }
        .panel-title { font-size: 16px; font-weight: 600; }
        .panel-close {
            width: 34px; height: 34px; border-radius: 50%; background: var(--bg-tertiary);
            border: none; color: var(--text-secondary); font-size: 14px; cursor: pointer;
        }
        .panel-close:hover { background: var(--border-medium); }
        .panel-body { flex: 1; overflow-y: auto; padding: 16px 20px; padding-bottom: calc(16px + var(--safe-bottom)); }

        .section { margin-bottom: 20px; }
        .section-label { font-size: 11px; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

        .bg-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .bg-item {
            width: 46px; height: 46px; border-radius: 10px; cursor: pointer;
            border: 2px solid transparent; transition: all 0.15s;
        }
        .bg-item:hover { transform: scale(1.08); }
        .bg-item.sel { border-color: white; }

        .export-list { display: flex; flex-direction: column; gap: 10px; }
        .export-item {
            padding: 14px; background: var(--bg-tertiary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md); cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .export-item:hover { border-color: var(--accent); }
        .export-item h4 { font-size: 14px; margin-bottom: 2px; }
        .export-item p { font-size: 11px; color: var(--text-muted); }
        .export-badge { padding: 4px 10px; background: var(--bg-secondary); border-radius: 100px; font-size: 10px; color: var(--text-secondary); }
        .export-item.rec .export-badge { background: var(--accent); color: white; }

        .layer-item {
            display: flex; align-items: center; padding: 12px 14px; background: var(--bg-tertiary);
            border-radius: var(--radius-sm); margin-bottom: 8px; cursor: pointer;
        }
        .layer-item:hover { background: var(--border-medium); }
        .layer-item.active { background: rgba(74,144,217,0.2); border: 1px solid rgba(74,144,217,0.4); }
        .layer-icon { margin-right: 12px; color: var(--text-muted); font-size: 14px; }
        .layer-name { flex: 1; font-size: 13px; }
        .layer-del { background: none; border: none; color: var(--text-muted); padding: 8px; cursor: pointer; border-radius: 6px; }
        .layer-del:hover { background: rgba(255,59,48,0.15); color: var(--error); }

        .tpl-panel {
            position: fixed; inset: 0; background: var(--bg-primary); z-index: 300;
            display: none; flex-direction: column;
        }
        .tpl-panel.show { display: flex; }
        .tpl-head {
            padding: 16px 20px; padding-top: calc(16px + var(--safe-top));
            background: var(--bg-secondary); border-bottom: 1px solid var(--border-subtle);
            display: flex; justify-content: space-between; align-items: center;
        }
        .tpl-title { font-size: 17px; font-weight: 600; }
        .tpl-close {
            width: 40px; height: 40px; background: var(--bg-tertiary); border: none;
            border-radius: 50%; color: var(--text-secondary); font-size: 15px; cursor: pointer;
        }
        .tpl-body { flex: 1; overflow-y: auto; padding: 16px; }
        .tpl-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
        
        .tpl-card {
            aspect-ratio: 3/4; border-radius: var(--radius-md); overflow: hidden;
            cursor: pointer; position: relative; background: var(--bg-tertiary);
            border: 2px solid transparent; transition: all 0.15s;
        }
        .tpl-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .tpl-preview {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 14px;
        }
        .tpl-img {
            width: 55%; height: 32%; background: linear-gradient(135deg, #e0e0e0, #c8c8c8);
            border-radius: 4px; margin-bottom: 10px; display: flex; align-items: center;
            justify-content: center; font-size: 20px;
        }
        .tpl-text { font-size: 11px; font-weight: 600; text-align: center; }
        .tpl-name {
            position: absolute; bottom: 0; left: 0; right: 0; padding: 10px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white; font-size: 12px; text-align: center;
        }

        .modal-bg {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 400;
            display: none; align-items: center; justify-content: center;
        }
        .modal-bg.show { display: flex; }
        .modal { background: var(--bg-secondary); padding: 24px; border-radius: var(--radius-lg); min-width: 260px; }
        .modal-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; text-align: center; }
        .modal input {
            background: var(--bg-tertiary); border: 1px solid var(--border-medium);
            color: var(--text-primary); padding: 14px; border-radius: var(--radius-sm);
            font-size: 20px; text-align: center; width: 100%; margin-bottom: 16px;
        }
        .modal input:focus { outline: none; border-color: var(--accent); }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btns button { flex: 1; padding: 12px; border-radius: var(--radius-sm); border: none; cursor: pointer; font-size: 14px; }
        .modal-btns .m-cancel { background: var(--bg-tertiary); color: var(--text-secondary); }
        .modal-btns .m-ok { background: var(--accent); color: white; }

        .toast {
            position: fixed; top: calc(68px + var(--safe-top)); left: 50%;
            transform: translateX(-50%) translateY(-16px);
            background: var(--bg-card); backdrop-filter: blur(16px);
            color: var(--text-primary); padding: 12px 22px; border-radius: 100px;
            font-size: 14px; z-index: 500; opacity: 0; pointer-events: none;
            transition: all 0.3s; border: 1px solid var(--border-medium);
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); border-color: var(--success); }

        .hidden { display: none; }

        @media (min-width: 768px) {
            .dock { max-width: 380px; left: 50%; transform: translateX(-50%); bottom: 20px; border-radius: 100px; border: 1px solid var(--border-subtle); }
            .tpl-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>

<body>
    <div class="loading-screen" id="loading">
        <div class="loading-logo">MONS</div>
    </div>

    <header class="header">
        <div class="brand">MONS</div>
        <div class="header-actions">
            <button class="btn btn-icon" onclick="undo()" title="Êí§ÈîÄ"><i class="fas fa-undo"></i></button>
            <button class="btn btn-icon" onclick="redo()" title="ÈáçÂÅö"><i class="fas fa-redo"></i></button>
            <button class="btn btn-icon" onclick="toggleFullscreen()" title="ÂÖ®Â±è"><i class="fas fa-expand" id="fsIcon"></i></button>
            <button class="btn btn-primary" onclick="showPanel('export')"><i class="fas fa-download"></i> ÂØºÂá∫</button>
        </div>
    </header>

    <div class="scene-bar" id="sceneBar"></div>

    <main class="workspace tool-hand" id="workspace">
        <div class="canvas-box" id="canvasBox">
            <canvas id="canvas"></canvas>
        </div>

        <div class="zoom-bar">
            <button class="zoom-btn" onclick="zoomOut()"><i class="fas fa-minus"></i></button>
            <div class="zoom-val" id="zoomVal" onclick="fitToScreen()">50%</div>
            <button class="zoom-btn" onclick="zoomIn()"><i class="fas fa-plus"></i></button>
            <div class="zoom-sep"></div>
            <button class="zoom-btn" onclick="fitToScreen()"><i class="fas fa-compress-arrows-alt"></i></button>
            <button class="zoom-btn" onclick="resetZoom()">1:1</button>
        </div>
    </main>

    <div class="tpl-panel" id="tplPanel">
        <div class="tpl-head">
            <span class="tpl-title" id="tplTitle">ÈÄâÊã©Ê®°Êùø</span>
            <button class="tpl-close" onclick="closeTpl()"><i class="fas fa-times"></i></button>
        </div>
        <div class="tpl-body">
            <div class="tpl-grid" id="tplGrid"></div>
        </div>
    </div>

    <div class="smart-toolbar" id="toolbar">
        <button class="tool-btn" onclick="duplicateObj()" title="Â§çÂà∂"><i class="fas fa-copy"></i></button>
        <button class="tool-btn" onclick="centerObj()" title="Â±Ö‰∏≠"><i class="fas fa-crosshairs"></i></button>
        <button class="tool-btn" onclick="bringFwd()" title="‰∏äÁßª"><i class="fas fa-chevron-up"></i></button>
        <button class="tool-btn" onclick="sendBwd()" title="‰∏ãÁßª"><i class="fas fa-chevron-down"></i></button>
        
        <div id="textTools" style="display:none;">
            <div class="tool-sep"></div>
            <select class="font-sel" id="fontSel" onchange="setFont(this.value)">
                <option value="Noto Serif SC">ÂÆã‰Ωì</option>
                <option value="Noto Sans SC">Èªë‰Ωì</option>
            </select>
            <div class="size-box">
                <button class="size-btn" onclick="adjSize(-4)">‚àí</button>
                <span class="size-val" id="sizeVal" onclick="showSizeModal()">64</span>
                <button class="size-btn" onclick="adjSize(4)">+</button>
            </div>
            <div class="color-row" id="colorRow">
                <div class="color-dot sel" style="background:#1A1A1A" onclick="setColor('#1A1A1A')"></div>
                <div class="color-dot" style="background:#888" onclick="setColor('#888888')"></div>
                <div class="color-dot" style="background:#FFF;border:1px solid #555" onclick="setColor('#FFFFFF')"></div>
                <div class="color-dot picker" onclick="pickColor()"></div>
            </div>
        </div>
        
        <div id="imgTools" style="display:none;">
            <div class="tool-sep"></div>
            <button class="tool-btn" onclick="replaceImg()" title="ÊõøÊç¢"><i class="fas fa-exchange-alt"></i></button>
            <button class="tool-btn" onclick="flipImg('x')"><i class="fas fa-arrows-alt-h"></i></button>
            <button class="tool-btn" onclick="flipImg('y')"><i class="fas fa-arrows-alt-v"></i></button>
        </div>
        
        <div class="tool-sep"></div>
        <button class="tool-btn danger" onclick="deleteObj()" title="Âà†Èô§"><i class="fas fa-trash"></i></button>
    </div>

    <div class="dock">
        <div class="dock-item" id="dockHand" onclick="setTool('hand')">
            <i class="fas fa-hand-paper"></i>
            <span>ÁîªÂ∏É</span>
        </div>
        <div class="dock-item" id="dockSelect" onclick="setTool('select')">
            <i class="fas fa-mouse-pointer"></i>
            <span>ÈÄâÊã©</span>
        </div>
        <div class="dock-item" id="dockAdd" onclick="toggleAdd()">
            <i class="fas fa-plus"></i>
            <span>Ê∑ªÂä†</span>
            <div class="add-popup" id="addPopup">
                <div class="add-item" onclick="startAddText(event)"><i class="fas fa-font"></i> ÊñáÂ≠ó</div>
                <div class="add-item" onclick="triggerImg(event)"><i class="fas fa-image"></i> ÂõæÁâá</div>
            </div>
        </div>
        <div class="dock-item" onclick="showPanel('canvas')">
            <i class="fas fa-palette"></i>
            <span>ËÉåÊôØ</span>
        </div>
        <div class="dock-item" onclick="showPanel('layers')">
            <i class="fas fa-layer-group"></i>
            <span>ÂõæÂ±Ç</span>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="hidePanel()"></div>

    <div class="panel" id="panel-canvas">
        <div class="panel-head">
            <span class="panel-title">ÁîªÂ∏ÉËÆæÁΩÆ</span>
            <button class="panel-close" onclick="hidePanel()"><i class="fas fa-times"></i></button>
        </div>
        <div class="panel-body">
            <div class="section">
                <div class="section-label">ËÉåÊôØÈ¢úËâ≤</div>
                <div class="bg-grid" id="bgGrid">
                    <div class="bg-item sel" style="background:#F8F6F1" data-c="#F8F6F1"></div>
                    <div class="bg-item" style="background:#FFFFFF" data-c="#FFFFFF"></div>
                    <div class="bg-item" style="background:#FAFAFA" data-c="#FAFAFA"></div>
                    <div class="bg-item" style="background:#E8E4DD" data-c="#E8E4DD"></div>
                    <div class="bg-item" style="background:#1A1A1A" data-c="#1A1A1A"></div>
                    <div class="bg-item" style="background:#0D0D0D" data-c="#0D0D0D"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="panel" id="panel-export">
        <div class="panel-head">
            <span class="panel-title">ÂØºÂá∫ÂõæÁâá</span>
            <button class="panel-close" onclick="hidePanel()"><i class="fas fa-times"></i></button>
        </div>
        <div class="panel-body">
            <div class="export-list">
                <div class="export-item" onclick="exportImg(1)">
                    <div><h4>Âø´ÈÄüÂàÜ‰∫´</h4><p>ÂæÆ‰ø°„ÄÅQQ</p></div>
                    <span class="export-badge">1x</span>
                </div>
                <div class="export-item rec" onclick="exportImg(2)">
                    <div><h4>È´òÊ∏ÖÂØºÂá∫</h4><p>Â∞èÁ∫¢‰π¶„ÄÅÊäñÈü≥</p></div>
                    <span class="export-badge">2x Êé®Ëçê</span>
                </div>
                <div class="export-item" onclick="exportImg(3)">
                    <div><h4>Ë∂ÖÊ∏ÖÂØºÂá∫</h4><p>Âç∞Âà∑„ÄÅÊµ∑Êä•</p></div>
                    <span class="export-badge">3x</span>
                </div>
            </div>
        </div>
    </div>

    <div class="panel" id="panel-layers">
        <div class="panel-head">
            <span class="panel-title">ÂõæÂ±Ç</span>
            <button class="panel-close" onclick="hidePanel()"><i class="fas fa-times"></i></button>
        </div>
        <div class="panel-body">
            <div id="layerList"></div>
        </div>
    </div>

    <div class="modal-bg" id="sizeModal">
        <div class="modal">
            <div class="modal-title">ËæìÂÖ•Â≠óÂè∑</div>
            <input type="number" id="sizeInput" min="8" max="500" value="64">
            <div class="modal-btns">
                <button class="m-cancel" onclick="closeSizeModal()">ÂèñÊ∂à</button>
                <button class="m-ok" onclick="confirmSize()">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>

    <input type="file" id="imgInput" class="hidden" accept="image/*" onchange="handleImg(this)">
    <input type="file" id="imgReplace" class="hidden" accept="image/*" onchange="handleReplace(this)">
    <input type="color" id="colorInput" class="hidden" onchange="applyColor(this.value)">
    <div class="toast" id="toast"></div>

    <script>
        // ÈÖçÁΩÆ
        const CONFIG = { version: 'V19', defaultBg: '#F8F6F1', initScale: 0.45 };

        // Âç†‰ΩçÂõæ
        function placeholder(w, h) {
            return 'data:image/svg+xml,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
                    <defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#E8E4DD"/><stop offset="100%" style="stop-color:#D8D4CD"/>
                    </linearGradient></defs>
                    <rect fill="url(#g)" width="${w}" height="${h}" rx="6"/>
                    <rect x="${w*0.28}" y="${h*0.22}" width="${w*0.44}" height="${h*0.36}" fill="#D0CCC5" rx="4"/>
                    <circle cx="${w*0.4}" cy="${h*0.32}" r="${Math.min(w,h)*0.05}" fill="#C0BBB2"/>
                    <polygon points="${w*0.32},${h*0.5} ${w*0.5},${h*0.36} ${w*0.68},${h*0.5}" fill="#C0BBB2"/>
                    <text x="${w/2}" y="${h*0.72}" text-anchor="middle" fill="#888" font-size="${Math.min(w,h)*0.045}" font-family="sans-serif">ÁÇπÂáªÊõøÊç¢ÂõæÁâá</text>
                </svg>
            `);
        }

        // Âú∫ÊôØ
        const SCENES = {
            'xhs': { name: 'üì± Â∞èÁ∫¢‰π¶Â∞ÅÈù¢', w: 1080, h: 1440, tpl: [
                { name: 'ÂõæÊñáÊéíÁâà', bg: '#F8F6F1', obj: [
                    { t:'img', x:0.5, y:0.35, w:0.7, h:0.4 },
                    { t:'txt', txt:'Ê†áÈ¢òÊñáÂ≠ó', x:0.5, y:0.72, s:56, f:'Noto Serif SC', c:'#1A1A1A' },
                    { t:'txt', txt:'ÂâØÊ†áÈ¢òÊèèËø∞', x:0.5, y:0.82, s:22, f:'Noto Sans SC', c:'#888' }
                ]},
                { name: 'ÊùÇÂøóÈ£é', bg: '#FFFFFF', obj: [
                    { t:'txt', txt:'MAGAZINE', x:0.5, y:0.06, s:16, f:'Noto Sans SC', c:'#333', sp:500 },
                    { t:'img', x:0.5, y:0.42, w:0.85, h:0.55 },
                    { t:'txt', txt:'Â∞ÅÈù¢Ê†áÈ¢ò', x:0.5, y:0.85, s:42, f:'Noto Serif SC', c:'#1A1A1A' }
                ]},
                { name: 'Ê∑±Ëâ≤È´òÁ∫ß', bg: '#1A1A1A', obj: [
                    { t:'img', x:0.5, y:0.38, w:0.65, h:0.42 },
                    { t:'txt', txt:'ÊöóËâ≤Ê†áÈ¢ò', x:0.5, y:0.75, s:48, f:'Noto Serif SC', c:'#FFFFFF' }
                ]}
            ]},
            'dy': { name: 'üé¨ ÊäñÈü≥', w: 1080, h: 1920, tpl: [
                { name: 'ËßÜÈ¢ëÂ∞ÅÈù¢', bg: '#0D0D0D', obj: [
                    { t:'img', x:0.5, y:0.4, w:0.8, h:0.45 },
                    { t:'txt', txt:'ËßÜÈ¢ëÊ†áÈ¢ò', x:0.5, y:0.75, s:52, f:'Noto Sans SC', c:'#FFF' }
                ]},
                { name: 'ÊïôÁ®ãÁ≥ªÂàó', bg: '#FFFFFF', obj: [
                    { t:'txt', txt:'ÊïôÁ®ã', x:0.5, y:0.1, s:22, f:'Noto Sans SC', c:'#888' },
                    { t:'img', x:0.5, y:0.4, w:0.85, h:0.42 },
                    { t:'txt', txt:'ÊäÄÂ∑ßÂàÜ‰∫´', x:0.5, y:0.75, s:44, f:'Noto Serif SC', c:'#1A1A1A' }
                ]}
            ]},
            'wx': { name: 'üí¨ ÊúãÂèãÂúà', w: 1080, h: 1080, tpl: [
                { name: 'ÊñπÂΩ¢ÂõæÊñá', bg: '#F8F6F1', obj: [
                    { t:'img', x:0.5, y:0.4, w:0.75, h:0.5 },
                    { t:'txt', txt:'Ê†áÈ¢òÊñáÂ≠ó', x:0.5, y:0.82, s:32, f:'Noto Serif SC', c:'#1A1A1A' }
                ]},
                { name: 'Êó•Á≠æÂç°Áâá', bg: '#FFFFFF', obj: [
                    { t:'txt', txt:'18', x:0.5, y:0.2, s:90, f:'Noto Serif SC', c:'#1A1A1A' },
                    { t:'txt', txt:'January', x:0.5, y:0.32, s:16, f:'Noto Sans SC', c:'#888' },
                    { t:'img', x:0.5, y:0.62, w:0.65, h:0.4 }
                ]}
            ]},
            'ppt': { name: 'üìä PPT', w: 1920, h: 1080, tpl: [
                { name: 'Ê†áÈ¢òÈ°µ', bg: '#FFFFFF', obj: [
                    { t:'txt', txt:'ÊºîÁ§∫Ê†áÈ¢ò', x:0.5, y:0.4, s:60, f:'Noto Serif SC', c:'#1A1A1A' },
                    { t:'txt', txt:'ÂâØÊ†áÈ¢ò', x:0.5, y:0.52, s:24, f:'Noto Sans SC', c:'#888' }
                ]}
            ]}
        };

        // Áä∂ÊÄÅ
        let scene = 'xhs', cW = 1080, cH = 1440;
        let scale = CONFIG.initScale, panX = 0, panY = 0;
        let tool = 'hand'; // hand | select | add
        let isPan = false, panSX = 0, panSY = 0;

        // Fabric
        const canvas = new fabric.Canvas('canvas', {
            width: cW, height: cH, backgroundColor: CONFIG.defaultBg,
            preserveObjectStacking: true, selection: true
        });

        const box = document.getElementById('canvasBox');
        const ws = document.getElementById('workspace');

        // ÂéÜÂè≤
        let hist = [], hIdx = -1;
        function saveHist() {
            if (hIdx < hist.length - 1) hist = hist.slice(0, hIdx + 1);
            hist.push(JSON.stringify(canvas.toJSON(['isPlaceholder'])));
            if (hist.length > 50) hist.shift(); else hIdx++;
            try { localStorage.setItem('mons_draft', hist[hIdx]); localStorage.setItem('mons_scene', scene); } catch(e) {}
        }
        function undo() { if (hIdx > 0) { hIdx--; canvas.loadFromJSON(hist[hIdx], () => canvas.renderAll()); toast('Â∑≤Êí§ÈîÄ'); }}
        function redo() { if (hIdx < hist.length - 1) { hIdx++; canvas.loadFromJSON(hist[hIdx], () => canvas.renderAll()); toast('Â∑≤ÈáçÂÅö'); }}

        canvas.on('object:added', saveHist);
        canvas.on('object:removed', saveHist);
        canvas.on('object:modified', saveHist);
        canvas.on('selection:created', showToolbar);
        canvas.on('selection:updated', showToolbar);
        canvas.on('selection:cleared', hideToolbar);
        canvas.on('mouse:dblclick', e => { if (e.target?.type === 'image') { canvas.setActiveObject(e.target); replaceImg(); }});

        saveHist();

        // ÂèòÊç¢
        function updateTf() {
            box.style.width = cW + 'px';
            box.style.height = cH + 'px';
            box.style.left = panX + 'px';
            box.style.top = panY + 'px';
            box.style.transform = `scale(${scale})`;
            box.style.transformOrigin = '0 0';
            document.getElementById('zoomVal').textContent = Math.round(scale * 100) + '%';
        }

        function fitToScreen() {
            const wW = ws.clientWidth, wH = ws.clientHeight, pad = 80;
            scale = Math.min((wW - pad * 2) / cW, (wH - pad * 2) / cH, 0.65);
            panX = (wW - cW * scale) / 2;
            panY = (wH - cH * scale) / 2;
            updateTf();
        }

        function resetZoom() {
            scale = 1;
            panX = (ws.clientWidth - cW) / 2;
            panY = (ws.clientHeight - cH) / 2;
            updateTf();
            toast('100%');
        }

        function zoomAt(ns, cx, cy) {
            const os = scale;
            scale = Math.max(0.1, Math.min(3, ns));
            panX = cx - (cx - panX) * (scale / os);
            panY = cy - (cy - panY) * (scale / os);
            updateTf();
        }

        function zoomIn() { zoomAt(scale * 1.25, ws.clientWidth / 2, ws.clientHeight / 2); }
        function zoomOut() { zoomAt(scale / 1.25, ws.clientWidth / 2, ws.clientHeight / 2); }

        // Â∑•ÂÖ∑
        function setTool(t) {
            tool = t;
            hideAdd();
            ws.className = 'workspace tool-' + t;
            document.querySelectorAll('.dock-item').forEach(el => el.classList.remove('active'));
            if (t === 'hand') {
                document.getElementById('dockHand').classList.add('active');
                canvas.discardActiveObject();
                canvas.renderAll();
                hideToolbar();
            } else if (t === 'select') {
                document.getElementById('dockSelect').classList.add('active');
            } else if (t === 'add') {
                document.getElementById('dockAdd').classList.add('active');
                canvas.discardActiveObject();
                canvas.renderAll();
                hideToolbar();
            }
        }

        function toggleAdd() {
            const p = document.getElementById('addPopup');
            if (p.classList.contains('show')) { hideAdd(); }
            else { p.classList.add('show'); }
        }
        function hideAdd() { document.getElementById('addPopup').classList.remove('show'); }

        function startAddText(e) {
            e.stopPropagation();
            hideAdd();
            setTool('add');
            toast('ÁÇπÂáªÁîªÂ∏ÉÊ∑ªÂä†ÊñáÂ≠ó');
        }

        function triggerImg(e) {
            if (e) e.stopPropagation();
            hideAdd();
            document.getElementById('imgInput').click();
        }

        // Â∑•‰ΩúÂå∫‰∫§‰∫í
        ws.addEventListener('mousedown', e => {
            if (tool === 'hand' && (e.target === ws || e.target === box)) {
                isPan = true;
                panSX = e.clientX - panX;
                panSY = e.clientY - panY;
                ws.classList.add('dragging');
            }
        });

        ws.addEventListener('click', e => {
            if (tool === 'add' && (e.target.tagName === 'CANVAS' || e.target === box)) {
                const rect = box.getBoundingClientRect();
                const x = (e.clientX - rect.left) / scale;
                const y = (e.clientY - rect.top) / scale;
                addTextAt(x, y);
                setTool('select');
            }
        });

        document.addEventListener('mousemove', e => {
            if (isPan) {
                panX = e.clientX - panSX;
                panY = e.clientY - panSY;
                updateTf();
            }
        });

        document.addEventListener('mouseup', () => {
            isPan = false;
            ws.classList.remove('dragging');
        });

        // Ëß¶Êë∏
        let tDist = 0, tScale = 1;
        ws.addEventListener('touchstart', e => {
            if (tool === 'hand' && e.target === ws) {
                if (e.touches.length === 1) {
                    isPan = true;
                    panSX = e.touches[0].clientX - panX;
                    panSY = e.touches[0].clientY - panY;
                } else if (e.touches.length === 2) {
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    tDist = Math.sqrt(dx * dx + dy * dy);
                    tScale = scale;
                }
            }
        }, { passive: true });

        ws.addEventListener('touchmove', e => {
            if (isPan && e.touches.length === 1) {
                panX = e.touches[0].clientX - panSX;
                panY = e.touches[0].clientY - panSY;
                updateTf();
            } else if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const d = Math.sqrt(dx * dx + dy * dy);
                const cx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                const cy = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                zoomAt(tScale * (d / tDist), cx, cy);
            }
        }, { passive: true });

        ws.addEventListener('touchend', () => { isPan = false; });

        // ÊªöËΩÆ
        ws.addEventListener('wheel', e => {
            e.preventDefault();
            const rect = ws.getBoundingClientRect();
            const mx = e.clientX - rect.left, my = e.clientY - rect.top;
            zoomAt(scale * (e.deltaY > 0 ? 0.9 : 1.1), mx, my);
        }, { passive: false });

        // Âú∫ÊôØ
        function renderScenes() {
            document.getElementById('sceneBar').innerHTML = Object.entries(SCENES).map(([id, s]) =>
                `<button class="scene-btn ${id === scene ? 'active' : ''}" data-s="${id}" onclick="openTpl('${id}')">${s.name}</button>`
            ).join('');
        }

        function openTpl(id) {
            const s = SCENES[id];
            document.getElementById('tplTitle').textContent = s.name;
            document.getElementById('tplGrid').innerHTML = s.tpl.map((t, i) => {
                const hasImg = t.obj.some(o => o.t === 'img');
                const dark = ['#1A1A1A', '#0D0D0D', '#000'].includes(t.bg);
                return `<div class="tpl-card" onclick="applyTpl('${id}',${i})">
                    <div class="tpl-preview" style="background:${t.bg};color:${dark ? '#fff' : '#1A1A1A'}">
                        ${hasImg ? '<div class="tpl-img">üñºÔ∏è</div>' : ''}
                        <div class="tpl-text">${t.obj.find(o => o.t === 'txt')?.txt || t.name}</div>
                    </div>
                    <div class="tpl-name">${t.name}</div>
                </div>`;
            }).join('');
            document.getElementById('tplPanel').classList.add('show');
        }

        function closeTpl() { document.getElementById('tplPanel').classList.remove('show'); }

        function applyTpl(id, idx) {
            const s = SCENES[id], t = s.tpl[idx];
            scene = id; cW = s.w; cH = s.h;

            document.querySelectorAll('.scene-btn').forEach(b => b.classList.toggle('active', b.dataset.s === id));

            canvas.clear();
            canvas.setDimensions({ width: cW, height: cH });
            canvas.setBackgroundColor(t.bg, canvas.renderAll.bind(canvas));

            t.obj.filter(o => o.t === 'txt').forEach(o => {
                canvas.add(new fabric.Textbox(o.txt, {
                    left: o.x * cW, top: o.y * cH,
                    fontSize: o.s, fontFamily: o.f, fill: o.c,
                    originX: 'center', originY: 'center', textAlign: 'center',
                    width: cW * 0.8, charSpacing: o.sp || 0
                }));
            });

            t.obj.filter(o => o.t === 'img').forEach(o => {
                const iW = Math.round(cW * o.w), iH = Math.round(cH * o.h);
                fabric.Image.fromURL(placeholder(iW, iH), img => {
                    img.set({ left: o.x * cW, top: o.y * cH, originX: 'center', originY: 'center', isPlaceholder: true });
                    canvas.add(img);
                    canvas.sendToBack(img);
                    canvas.renderAll();
                }, { crossOrigin: 'anonymous' });
            });

            closeTpl();
            setTimeout(fitToScreen, 50);
            toast('‚úì Â∑≤Â∫îÁî®Ê®°Êùø');
        }

        // Â∑•ÂÖ∑Ê†è
        function showToolbar(e) {
            const obj = e?.target || canvas.getActiveObject();
            if (!obj) return hideToolbar();
            document.getElementById('toolbar').classList.add('show');
            const tt = document.getElementById('textTools'), it = document.getElementById('imgTools');
            if (obj.type === 'textbox') {
                tt.style.display = 'flex'; it.style.display = 'none';
                document.getElementById('sizeVal').textContent = Math.round(obj.fontSize);
                document.getElementById('fontSel').value = obj.fontFamily || 'Noto Serif SC';
            } else if (obj.type === 'image') {
                tt.style.display = 'none'; it.style.display = 'flex';
            } else {
                tt.style.display = 'none'; it.style.display = 'none';
            }
        }
        function hideToolbar() { document.getElementById('toolbar').classList.remove('show'); }

        // ÊñáÂ≠ó
        function addTextAt(x, y) {
            canvas.add(new fabric.Textbox('ÂèåÂáªÁºñËæë', {
                left: x, top: y, fontSize: 56, fontFamily: 'Noto Serif SC', fill: '#1A1A1A',
                originX: 'center', originY: 'center', textAlign: 'center', width: cW * 0.7
            }));
            canvas.setActiveObject(canvas.getObjects().slice(-1)[0]);
            canvas.renderAll();
            toast('‚úì Â∑≤Ê∑ªÂä†ÊñáÂ≠ó');
        }

        function setFont(f) { const o = canvas.getActiveObject(); if (o?.type === 'textbox') { o.set('fontFamily', f); canvas.renderAll(); saveHist(); }}
        function adjSize(d) { const o = canvas.getActiveObject(); if (o?.type === 'textbox') { const s = Math.max(8, Math.min(500, o.fontSize + d)); o.set('fontSize', s); document.getElementById('sizeVal').textContent = s; canvas.renderAll(); saveHist(); }}
        function showSizeModal() { const o = canvas.getActiveObject(); if (o?.type === 'textbox') { document.getElementById('sizeInput').value = Math.round(o.fontSize); document.getElementById('sizeModal').classList.add('show'); }}
        function closeSizeModal() { document.getElementById('sizeModal').classList.remove('show'); }
        function confirmSize() { const o = canvas.getActiveObject(); const v = parseInt(document.getElementById('sizeInput').value); if (o?.type === 'textbox' && v >= 8 && v <= 500) { o.set('fontSize', v); document.getElementById('sizeVal').textContent = v; canvas.renderAll(); saveHist(); } closeSizeModal(); }
        
        function setColor(c) {
            const o = canvas.getActiveObject();
            if (o?.type === 'textbox') {
                o.set('fill', c); canvas.renderAll(); saveHist();
                document.querySelectorAll('#colorRow .color-dot:not(.picker)').forEach(e => {
                    e.classList.toggle('sel', rgbHex(e.style.backgroundColor).toUpperCase() === c.toUpperCase());
                });
            }
        }
        function rgbHex(rgb) { if (!rgb || rgb.startsWith('#')) return rgb; const m = rgb.match(/\d+/g); if (!m) return rgb; return '#' + m.slice(0, 3).map(x => parseInt(x).toString(16).padStart(2, '0')).join(''); }
        function pickColor() { document.getElementById('colorInput').click(); }
        function applyColor(c) { setColor(c); }

        // ÂõæÁâá
        function handleImg(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 10 * 1024 * 1024) { toast('ÂõæÁâáËøáÂ§ß'); return; }
            const reader = new FileReader();
            reader.onload = e => {
                fabric.Image.fromURL(e.target.result, img => {
                    if (!img) { toast('Âä†ËΩΩÂ§±Ë¥•'); return; }
                    const maxDim = Math.min(cW, cH) * 0.5;
                    const s = Math.min(maxDim / img.width, maxDim / img.height, 1);
                    img.set({ left: cW / 2, top: cH / 2, originX: 'center', originY: 'center', scaleX: s, scaleY: s });
                    canvas.add(img);
                    canvas.setActiveObject(img);
                    canvas.renderAll();
                    setTool('select');
                    toast('‚úì Â∑≤Ê∑ªÂä†ÂõæÁâá');
                }, { crossOrigin: 'anonymous' });
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        function replaceImg() {
            const o = canvas.getActiveObject();
            if (o?.type === 'image') document.getElementById('imgReplace').click();
        }

        function handleReplace(input) {
            const file = input.files[0];
            if (!file) return;
            const o = canvas.getActiveObject();
            if (!o || o.type !== 'image') return;

            const reader = new FileReader();
            reader.onload = e => {
                fabric.Image.fromURL(e.target.result, newImg => {
                    if (!newImg) { toast('Âä†ËΩΩÂ§±Ë¥•'); return; }
                    const oW = o.width * o.scaleX, oH = o.height * o.scaleY;
                    const s = Math.min(oW / newImg.width, oH / newImg.height);
                    newImg.set({ left: o.left, top: o.top, originX: o.originX, originY: o.originY, scaleX: s, scaleY: s, isPlaceholder: false });
                    const idx = canvas.getObjects().indexOf(o);
                    canvas.remove(o);
                    canvas.insertAt(newImg, idx);
                    canvas.setActiveObject(newImg);
                    canvas.renderAll();
                    toast('‚úì Â∑≤ÊõøÊç¢ÂõæÁâá');
                }, { crossOrigin: 'anonymous' });
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        function flipImg(axis) { const o = canvas.getActiveObject(); if (o?.type === 'image') { o.set(axis === 'x' ? 'flipX' : 'flipY', axis === 'x' ? !o.flipX : !o.flipY); canvas.renderAll(); saveHist(); }}

        // ÈÄöÁî®
        function duplicateObj() { const o = canvas.getActiveObject(); if (!o) return; o.clone(c => { c.set({ left: o.left + 30, top: o.top + 30 }); canvas.add(c); canvas.setActiveObject(c); canvas.renderAll(); toast('‚úì Â∑≤Â§çÂà∂'); }, ['isPlaceholder']); }
        function deleteObj() { const o = canvas.getActiveObject(); if (!o) return; canvas.remove(o); canvas.renderAll(); toast('‚úì Â∑≤Âà†Èô§'); }
        function bringFwd() { const o = canvas.getActiveObject(); if (o) { canvas.bringForward(o); canvas.renderAll(); saveHist(); }}
        function sendBwd() { const o = canvas.getActiveObject(); if (o) { canvas.sendBackwards(o); canvas.renderAll(); saveHist(); }}
        function centerObj() { const o = canvas.getActiveObject(); if (o) { o.set({ left: cW / 2, top: cH / 2, originX: 'center', originY: 'center' }); o.setCoords(); canvas.renderAll(); saveHist(); toast('‚úì Â∑≤Â±Ö‰∏≠'); }}

        // ËÉåÊôØ
        document.getElementById('bgGrid').addEventListener('click', e => {
            const item = e.target.closest('.bg-item');
            if (!item) return;
            canvas.setBackgroundColor(item.dataset.c, canvas.renderAll.bind(canvas));
            saveHist();
            document.querySelectorAll('.bg-item').forEach(i => i.classList.remove('sel'));
            item.classList.add('sel');
        });

        // Èù¢Êùø
        function showPanel(id) { hidePanel(); document.getElementById('overlay').classList.add('show'); document.getElementById(`panel-${id}`).classList.add('show'); if (id === 'layers') updateLayers(); }
        function hidePanel() { document.getElementById('overlay').classList.remove('show'); document.querySelectorAll('.panel').forEach(p => p.classList.remove('show')); }

        function updateLayers() {
            const list = document.getElementById('layerList'), objs = canvas.getObjects();
            if (!objs.length) { list.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px">ÊöÇÊó†ÂõæÂ±Ç</div>'; return; }
            list.innerHTML = objs.map((o, i) => {
                const active = canvas.getActiveObject() === o;
                let icon = 'fa-shapes', name = 'ÂΩ¢Áä∂';
                if (o.type === 'textbox') { icon = 'fa-font'; name = o.text.substring(0, 10) + (o.text.length > 10 ? '...' : ''); }
                else if (o.type === 'image') { icon = 'fa-image'; name = o.isPlaceholder ? 'Âç†‰ΩçÂõæ' : 'ÂõæÁâá'; }
                return `<div class="layer-item ${active ? 'active' : ''}" onclick="selLayer(${i})"><i class="fas ${icon} layer-icon"></i><span class="layer-name">${name}</span><button class="layer-del" onclick="event.stopPropagation();delLayer(${i})"><i class="fas fa-trash"></i></button></div>`;
            }).reverse().join('');
        }
        function selLayer(i) { setTool('select'); const o = canvas.getObjects()[i]; if (o) { canvas.setActiveObject(o); canvas.renderAll(); updateLayers(); }}
        function delLayer(i) { const o = canvas.getObjects()[i]; if (o) { canvas.remove(o); canvas.renderAll(); updateLayers(); }}

        // ÂØºÂá∫
        function exportImg(m) {
            canvas.discardActiveObject();
            canvas.renderAll();
            const url = canvas.toDataURL({ format: 'jpeg', quality: 0.95, multiplier: m });
            const link = document.createElement('a');
            link.download = `MONS_${scene}_${m}x_${Date.now()}.jpg`;
            link.href = url;
            link.click();
            hidePanel();
            toast('‚úì Â∑≤ÂØºÂá∫', 'success');
        }

        // ÂÖ®Â±è
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(() => {});
                document.getElementById('fsIcon').className = 'fas fa-compress';
            } else {
                document.exitFullscreen();
                document.getElementById('fsIcon').className = 'fas fa-expand';
            }
        }

        // Toast
        function toast(msg, type = '') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show' + (type ? ' ' + type : '');
            clearTimeout(t._t);
            t._t = setTimeout(() => t.classList.remove('show'), 2000);
        }

        // Âø´Êç∑ÈîÆ
        document.addEventListener('keydown', e => {
            if (e.target.matches('input, textarea')) return;
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) { e.preventDefault(); undo(); }
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) { e.preventDefault(); redo(); }
            if (e.key === 'Delete' || e.key === 'Backspace') { if (canvas.getActiveObject()) { e.preventDefault(); deleteObj(); }}
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') { e.preventDefault(); duplicateObj(); }
            if (e.key === 'Escape') { closeTpl(); hidePanel(); closeSizeModal(); hideAdd(); setTool('hand'); canvas.discardActiveObject(); canvas.renderAll(); }
            if ((e.ctrlKey || e.metaKey) && e.key === '0') { e.preventDefault(); fitToScreen(); }
            if (e.key === 'v' || e.key === 'V') { setTool('select'); }
            if (e.key === 'h' || e.key === 'H') { setTool('hand'); }
        });

        window.addEventListener('resize', fitToScreen);
        document.addEventListener('click', e => { if (!e.target.closest('#dockAdd')) hideAdd(); });

        // ÂàùÂßãÂåñ
        renderScenes();
        setTool('hand');

        document.fonts.ready.then(() => {
            setTimeout(() => {
                document.getElementById('loading').classList.add('hide');
                try {
                    const sc = localStorage.getItem('mons_scene');
                    if (sc && SCENES[sc]) {
                        scene = sc;
                        cW = SCENES[sc].w;
                        cH = SCENES[sc].h;
                        canvas.setDimensions({ width: cW, height: cH });
                        renderScenes();
                    }
                    const draft = localStorage.getItem('mons_draft');
                    if (draft) {
                        canvas.loadFromJSON(draft, () => { canvas.renderAll(); fitToScreen(); });
                    } else {
                        applyTpl('xhs', 0);
                    }
                } catch(e) { applyTpl('xhs', 0); }
            }, 400);
        });

        setTimeout(() => { document.getElementById('loading').classList.add('hide'); applyTpl('xhs', 0); }, 4000);

        console.log(`üèîÔ∏è MONS ${CONFIG.version}`);
    </script>
</body>
</html>
