<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MONS - æç®€è®¾è®¡</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230D0D0D' width='100' height='100' rx='18'/><text x='50' y='68' text-anchor='middle' fill='white' font-size='45' font-weight='bold' font-family='Georgia,serif'>M</text></svg>">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* èƒŒæ™¯ç³»ç»Ÿ - çº¯é»‘ç™½ç°å±‚æ¬¡ */
            --bg-primary: #000000;      /* çº¯é»‘ */
            --bg-secondary: #121212;     /* æ·±ç° */
            --bg-tertiary: #1E1E1E;      /* ä¸­æ·±ç° */
            --bg-workspace: #1A1A1A;     /* å·¥ä½œåŒºèƒŒæ™¯ */
            --bg-card: rgba(20,20,20,0.98); /* å¡ç‰‡èƒŒæ™¯ */
            --bg-hover: rgba(255,255,255,0.08); /* æ‚¬åœèƒŒæ™¯ */
            --bg-active: rgba(255,255,255,0.15); /* æ¿€æ´»èƒŒæ™¯ */
            
            /* è¾¹æ¡†ç³»ç»Ÿ - ç°åº¦å±‚æ¬¡ */
            --border-subtle: rgba(255,255,255,0.12); /* ç»†å¾®è¾¹æ¡† */
            --border-medium: rgba(255,255,255,0.20); /* ä¸­ç­‰è¾¹æ¡† */
            --border-focused: rgba(255,255,255,0.30); /* èšç„¦è¾¹æ¡† */
            
            /* æ–‡å­—ç³»ç»Ÿ - ä¼˜åŒ–å¯è¯»æ€§ */
            --text-primary: #FFFFFF;      /* ä¸»æ–‡å­— */
            --text-secondary: rgba(255,255,255,0.85); /* æ¬¡è¦æ–‡å­— */
            --text-muted: rgba(255,255,255,0.60); /* é™éŸ³æ–‡å­— */
            --text-disabled: rgba(255,255,255,0.40); /* ç¦ç”¨æ–‡å­— */
            
            /* å¼ºè°ƒè‰²ç³»ç»Ÿ - ç°åº¦å¼ºè°ƒ */
            --accent: rgba(255,255,255,0.80); /* ä¸»è¦å¼ºè°ƒè‰² */
            --accent-hover: rgba(255,255,255,0.90); /* æ‚¬åœå¼ºè°ƒè‰² */
            --accent-active: rgba(255,255,255,0.70); /* æ¿€æ´»å¼ºè°ƒè‰² */
            
            /* çŠ¶æ€é¢œè‰² - ç°åº¦çŠ¶æ€ */
            --success: rgba(255,255,255,0.70); /* æˆåŠŸçŠ¶æ€ */
            --success-hover: rgba(255,255,255,0.80); /* æˆåŠŸæ‚¬åœ */
            --error: rgba(255,255,255,0.60); /* é”™è¯¯çŠ¶æ€ */
            --error-hover: rgba(255,255,255,0.70); /* é”™è¯¯æ‚¬åœ */
            --warning: rgba(255,255,255,0.50); /* è­¦å‘ŠçŠ¶æ€ */
            --warning-hover: rgba(255,255,255,0.60); /* è­¦å‘Šæ‚¬åœ */
            
            /* å°ºå¯¸ç³»ç»Ÿ */
            --radius-sm: 10px;
            --radius-md: 14px;
            --radius-lg: 24px;
            --radius-full: 100px;
            
            /* å­—ä½“ç³»ç»Ÿ */
            --font-sans: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-serif: 'Noto Serif SC', Georgia, serif;
            
            /* å®‰å…¨åŒºåŸŸ */
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            
            /* è¿‡æ¸¡æ•ˆæœ - ç»Ÿä¸€åŠ¨ç”»ä½“éªŒ */
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; position: fixed; width: 100%; }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-sans);
            display: flex;
            flex-direction: column;
            padding-top: var(--safe-top);
        }

        .loading-screen {
            position: fixed; inset: 0; background: var(--bg-primary);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; transition: opacity var(--transition-slow), transform var(--transition-slow);
        }
        .loading-screen.hide {
            opacity: 0; pointer-events: none; transform: translateY(-20px);
        }
        .loading-logo {
            font-size: 38px; font-weight: 700; letter-spacing: 12px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
        }
        .loading-subtitle {
            font-size: 13px; color: var(--text-muted);
            font-weight: 400;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .loading-spinner {
            width: 32px;
            height: 32px;
            margin-top: 24px;
            border: 2px solid var(--border-subtle);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .header {
            height: 56px; background: var(--bg-secondary); 
            border-bottom: 1px solid var(--border-subtle);
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 18px; flex-shrink: 0; z-index: 100;
            backdrop-filter: blur(10px);
            transition: all var(--transition-fast);
        }
        .brand {
            font-size: 18px; font-weight: 600; letter-spacing: 6px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-actions {
            display: flex; gap: 8px; align-items: center;
        }
        
        .btn {
            background: transparent; color: var(--text-secondary); 
            border: 1px solid var(--border-medium);
            padding: 0 18px; height: 38px; 
            border-radius: var(--radius-sm); 
            font-size: 13px; font-weight: 500;
            cursor: pointer; 
            transition: all var(--transition-fast);
            display: flex; align-items: center; gap: 8px;
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left var(--transition-normal);
        }
        .btn:hover::before {
            left: 100%;
        }
        .btn:hover {
            background: var(--bg-hover); 
            color: var(--text-primary);
            border-color: var(--border-focused);
        }
        .btn:active {
            transform: scale(0.97);
            background: var(--bg-active);
        }
        .btn-primary {
            background: var(--accent); 
            color: white; 
            border: none;
            box-shadow: 0 2px 8px rgba(74,144,217,0.3);
        }
        .btn-primary:hover {
            background: var(--accent-hover);
            box-shadow: 0 4px 12px rgba(74,144,217,0.4);
        }
        .btn-primary:active {
            background: var(--accent-active);
            box-shadow: 0 2px 6px rgba(74,144,217,0.25);
        }
        .btn-icon {
            width: 38px; height: 38px; 
            padding: 0; justify-content: center; 
            border-radius: 50%; 
            font-size: 14px;
        }
        .btn-icon:hover {
            background: var(--bg-hover);
            border-color: var(--border-focused);
        }

        .scene-bar {
            display: flex; gap: 8px; padding: 10px 16px; background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle); 
            overflow-x: auto; flex-shrink: 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .scene-bar::-webkit-scrollbar { 
            display: none; 
        }
        .scene-btn {
            flex-shrink: 0; 
            padding: 9px 18px; 
            background: var(--bg-tertiary); 
            border: 1px solid transparent;
            border-radius: var(--radius-full); 
            color: var(--text-secondary); 
            font-size: 13px; 
            font-weight: 500;
            cursor: pointer; 
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        .scene-btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left var(--transition-normal);
        }
        .scene-btn:hover::before {
            left: 100%;
        }
        .scene-btn:hover {
            background: var(--bg-hover); 
            color: var(--text-primary);
            transform: translateY(-1px);
        }
        .scene-btn:active {
            transform: translateY(0);
        }
        .scene-btn.active {
            background: var(--accent); 
            color: white;
            box-shadow: 0 2px 8px rgba(74,144,217,0.3);
            border-color: var(--accent);
        }

        .workspace {
            flex: 1; position: relative; overflow: hidden;
            background: var(--bg-workspace);
            background-image: 
                linear-gradient(45deg, rgba(255,255,255,0.02) 25%, transparent 25%),
                linear-gradient(-45deg, rgba(255,255,255,0.02) 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, rgba(255,255,255,0.02) 75%),
                linear-gradient(-45deg, transparent 75%, rgba(255,255,255,0.02) 75%);
            background-size: 32px 32px;
            background-position: 0 0, 0 16px, 16px -16px, -16px 0px;
        }
        
        .workspace.tool-hand { cursor: grab; }
        .workspace.tool-hand.dragging { cursor: grabbing; }
        .workspace.tool-select { cursor: default; }
        .workspace.tool-add { cursor: crosshair; }

        .canvas-box {
            position: absolute;
            box-shadow: 0 16px 60px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05);
            transition: box-shadow var(--transition-fast);
        }
        
        .workspace.tool-hand .canvas-box,
        .workspace.tool-add .canvas-box { pointer-events: none; }
        
        /* èšç„¦æ•ˆæœ */
        .canvas-box:focus-within {
            box-shadow: 0 16px 60px rgba(74,144,217,0.4), 0 0 0 1px var(--border-focused);
        }

        .zoom-bar {
            position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%);
            background: var(--bg-card); backdrop-filter: blur(20px);
            border: 1px solid var(--border-medium); 
            border-radius: var(--radius-full);
            padding: 6px 16px; 
            display: flex; align-items: center; gap: 8px; 
            z-index: 60;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .zoom-btn {
            width: 34px; height: 34px; 
            border-radius: 50%; 
            background: transparent; 
            border: none;
            color: var(--text-secondary); 
            font-size: 13px; 
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; 
            transition: all var(--transition-fast);
            position: relative;
        }
        .zoom-btn:hover {
            background: var(--bg-hover); 
            color: var(--accent);
            transform: scale(1.05);
        }
        .zoom-btn:active {
            transform: scale(0.95);
            background: var(--bg-active);
        }
        .zoom-val {
            min-width: 50px; 
            text-align: center; 
            font-size: 13px; 
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer; 
            padding: 6px 8px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            transition: all var(--transition-fast);
        }
        .zoom-val:hover {
            background: var(--bg-hover);
            transform: scale(1.05);
        }
        .zoom-sep {
            width: 1px; 
            height: 22px; 
            background: var(--border-subtle); 
        }

        .smart-toolbar {
            position: fixed; 
            bottom: calc(96px + var(--safe-bottom)); 
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--bg-card); 
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-medium); 
            border-radius: 16px;
            padding: 10px 14px; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            z-index: 95;
            opacity: 0; 
            pointer-events: none; 
            transition: all var(--transition-normal) cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
            max-width: 92vw;
            flex-wrap: wrap;
            justify-content: center;
        }
        .smart-toolbar.show {
            transform: translateX(-50%) translateY(0); 
            opacity: 1; 
            pointer-events: auto;
        }
        
        .tool-btn {
            min-width: 40px; 
            height: 40px; 
            border-radius: 10px; 
            background: transparent; 
            border: none;
            color: var(--text-secondary); 
            font-size: 15px; 
            cursor: pointer; 
            transition: all var(--transition-fast);
            display: flex; 
            align-items: center; 
            justify-content: center;
            position: relative;
        }
        .tool-btn:hover {
            background: var(--bg-hover); 
            color: var(--accent);
            transform: translateY(-1px);
        }
        .tool-btn:active {
            transform: scale(0.94) translateY(0);
            background: var(--bg-active);
        }
        .tool-btn.danger:hover {
            background: rgba(255,59,48,0.15); 
            color: var(--error-hover);
        }
        .tool-sep {
            width: 1px; 
            height: 28px; 
            background: var(--border-subtle); 
            margin: 0 6px;
        }

        .font-sel {
            background: var(--bg-tertiary); 
            border: 1px solid var(--border-subtle); 
            color: var(--text-primary); 
            padding: 0 12px; 
            height: 34px; 
            border-radius: 8px; 
            font-size: 12px; 
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .font-sel:hover {
            border-color: var(--border-focused);
            background: var(--bg-hover);
        }
        .font-sel:focus {
            outline: none;
            border-color: var(--border-focused);
            box-shadow: 0 0 0 2px rgba(74,144,217,0.2);
        }

        .size-box {
            display: flex; 
            align-items: center; 
            background: var(--bg-tertiary); 
            border-radius: 8px; 
            padding: 3px;
            height: 34px;
        }
        .size-btn {
            width: 28px; 
            height: 28px; 
            border-radius: 6px; 
            background: transparent; 
            border: none; 
            color: var(--text-secondary); 
            font-size: 14px; 
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .size-btn:hover {
            background: var(--bg-hover);
            color: var(--accent);
        }
        .size-val {
            min-width: 40px; 
            text-align: center; 
            font-size: 12px; 
            color: var(--text-primary); 
            font-weight: 600;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all var(--transition-fast);
        }
        .size-val:hover {
            background: var(--bg-hover);
        }

        .color-row {
            display: flex; 
            gap: 6px; 
            margin-left: 8px;
        }
        .color-dot {
            width: 26px; 
            height: 26px; 
            border-radius: 50%; 
            cursor: pointer;
            border: 2px solid transparent;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        .color-dot:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .color-dot.sel {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(74,144,217,0.3);
        }
        .color-dot.picker {
            background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);
        }
        .color-dot.picker::after {
            content: '+';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .dock {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-card); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-subtle);
            padding: 10px 16px; padding-bottom: calc(10px + var(--safe-bottom));
            display: flex; justify-content: center; gap: 8px; z-index: 90;
            box-shadow: 0 8px 40px rgba(0,0,0,0.05);
        }
        .dock-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            padding: 10px 16px; border-radius: var(--radius-md); cursor: pointer;
            color: var(--text-muted); transition: all var(--transition-fast); position: relative;
            min-width: 80px;
        }
        .dock-item:hover {
            background: var(--bg-hover); color: var(--text-secondary);
            transform: translateY(-2px);
        }
        .dock-item:active { transform: scale(0.96) translateY(0); }
        .dock-item.active { color: var(--accent); background: rgba(74,144,217,0.15); }
        .dock-item i { font-size: 20px; }
        .dock-item span { font-size: 10px; font-weight: 500; letter-spacing: 0.5px; }

        /* æ·»åŠ å¼¹çª— */
        .add-popup {
            position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
            background: var(--bg-card); backdrop-filter: blur(20px);
            border: 1px solid var(--border-medium); border-radius: var(--radius-md);
            padding: 12px;
            margin-bottom: 10px; 
            display: none; 
            flex-direction: column; 
            gap: 8px;
            min-width: 200px;
            z-index: 95;
            box-shadow: 0 12px 48px rgba(0,0,0,0.4);
            animation: popupSlideUp var(--transition-normal) ease-out;
        }
        @keyframes popupSlideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        .add-popup.show { display: flex; }
        .add-item {
            display: flex; align-items: center; gap: 10px; padding: 12px 14px;
            border-radius: var(--radius-sm); cursor: pointer; color: var(--text-secondary);
            transition: all var(--transition-fast); font-size: 13px;
        }
        .add-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .add-item i { width: 18px; text-align: center; font-size: 14px; }

        .overlay {
            position: fixed; inset: 0; 
            background: rgba(0,0,0,0.55); 
            z-index: 140;
            opacity: 0; 
            pointer-events: none; 
            transition: opacity var(--transition-normal);
            backdrop-filter: blur(4px);
        }
        .overlay.show { 
            opacity: 1; 
            pointer-events: auto;
        }

        .panel {
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0;
            background: var(--bg-secondary); 
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            z-index: 150; 
            transform: translateY(100%);
            transition: transform var(--transition-slow) cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 75vh; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 -16px 80px rgba(0,0,0,0.4);
        }
        .panel.show { 
            transform: translateY(0); 
        }
        .panel-head {
            padding: 18px 20px; 
            border-bottom: 1px solid var(--border-subtle);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .panel-title {
            font-size: 16px; 
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .panel-close {
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            color: var(--text-secondary); 
            font-size: 14px; 
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .panel-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-medium);
        }
        .panel-body {
            flex: 1; 
            overflow-y: auto; 
            padding: 16px 20px; 
            padding-bottom: calc(16px + var(--safe-bottom));
            scrollbar-width: thin;
            scrollbar-color: var(--border-medium) transparent;
        }
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .panel-body::-webkit-scrollbar {
            width: 6px;
        }
        .panel-body::-webkit-scrollbar-track {
            background: transparent;
        }
        .panel-body::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 3px;
        }
        .panel-body::-webkit-scrollbar-thumb:hover {
            background: var(--border-focused);
        }

        .section {
            margin-bottom: 24px;
        }
        .section-label {
            font-size: 11px; 
            color: var(--text-muted); 
            margin-bottom: 12px; 
            text-transform: uppercase; 
            letter-spacing: 1.2px; 
            font-weight: 600;
        }

        /* èƒŒæ™¯ç½‘æ ¼ */
        .bg-grid {
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px;
        }
        .bg-item {
            width: 50px; 
            height: 50px; 
            border-radius: 12px; 
            cursor: pointer;
            border: 2px solid transparent;
            transition: all var(--transition-fast);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .bg-item:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }
        .bg-item.sel {
            border-color: var(--border-focused);
            box-shadow: 0 0 0 3px rgba(74,144,217,0.2);
        }

        /* å¯¼å‡ºåˆ—è¡¨ */
        .export-list {
            display: flex; 
            flex-direction: column; 
            gap: 12px;
        }
        .export-item {
            padding: 16px;
            background: var(--bg-tertiary); 
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md); 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        .export-item::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(74,144,217,0.1), transparent);
            transition: left var(--transition-normal);
        }
        .export-item:hover {
            border-color: var(--border-focused);
            background: var(--bg-hover);
            transform: translateX(4px);
        }
        .export-item:hover::before {
            left: 100%;
        }
        .export-item h4 {
            font-size: 15px; 
            margin-bottom: 4px; 
        }
        .export-item p {
            font-size: 12px; 
            color: var(--text-muted);
        }
        .export-badge {
            padding: 5px 12px; 
            background: var(--bg-secondary); 
            border-radius: var(--radius-full); 
            font-size: 11px; 
            color: var(--text-secondary);
            font-weight: 500;
        }
        .export-item.rec .export-badge {
            background: var(--accent); 
            color: white;
        }

        /* å›¾å±‚é¡¹ */
        .layer-item {
            display: flex; 
            align-items: center; 
            padding: 14px 16px; 
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm); 
            margin-bottom: 10px; 
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid transparent;
        }
        .layer-item:hover {
            background: var(--bg-hover);
            transform: translateX(4px);
        }
        .layer-item.active {
            background: rgba(74,144,217,0.15); 
            border: 1px solid var(--border-focused);
        }
        .layer-icon {
            margin-right: 14px; 
            color: var(--text-muted); 
            font-size: 14px;
        }
        .layer-name {
            flex: 1; 
            font-size: 13px;
        }
        .layer-del {
            background: none; 
            border: none; 
            color: var(--text-muted); 
            padding: 10px; 
            cursor: pointer; 
            border-radius: 8px;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
        }
        .layer-del:hover {
            background: rgba(255,59,48,0.15); 
            color: var(--error-hover);
            transform: scale(1.1);
        }

        /* æ¨¡æ¿é¢æ¿ */
        .tpl-panel {
            position: fixed; inset: 0; background: var(--bg-primary); z-index: 300;
            display: none; flex-direction: column;
        }
        .tpl-panel.show { 
            display: flex;
            animation: fadeIn var(--transition-normal);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .tpl-head {
            padding: 18px 20px; 
            padding-top: calc(18px + var(--safe-top));
            background: var(--bg-secondary); 
            border-bottom: 1px solid var(--border-subtle);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .tpl-title {
            font-size: 17px; 
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .tpl-close {
            width: 42px; 
            height: 42px; 
            background: var(--bg-tertiary); 
            border: 1px solid transparent;
            border-radius: 50%; 
            color: var(--text-secondary); 
            font-size: 16px; 
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tpl-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-medium);
        }
        .tpl-body { flex: 1; overflow-y: auto; padding: 16px; }
        .tpl-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
        
        .tpl-card {
            aspect-ratio: 3/4; 
            border-radius: var(--radius-md); 
            overflow: hidden;
            cursor: pointer; 
            position: relative; 
            background: var(--bg-tertiary);
            border: 2px solid transparent; 
            transition: all var(--transition-fast);
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        .tpl-card:hover {
            border-color: var(--border-focused); 
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0,0,0,0.3);
        }
        .tpl-card:active {
            transform: translateY(-2px);
        }
        .tpl-preview {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 16px;
        }
        .tpl-img {
            width: 55%; height: 32%; 
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: 6px; margin-bottom: 12px; 
            display: flex; align-items: center;
            justify-content: center; font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .tpl-text {
            font-size: 12px; 
            font-weight: 600; 
            text-align: center;
            line-height: 1.4;
        }
        .tpl-name {
            position: absolute; bottom: 0; left: 0; right: 0; padding: 12px;
            background: linear-gradient(transparent, rgba(0,0,0,0.85));
            color: white; font-size: 13px; text-align: center;
            font-weight: 500;
        }

        .modal-bg {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 400;
            display: none; align-items: center; justify-content: center;
        }
        .modal-bg.show { display: flex; }
        .modal { background: var(--bg-secondary); padding: 24px; border-radius: var(--radius-lg); min-width: 260px; }
        .modal-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; text-align: center; }
        .modal input {
            background: var(--bg-tertiary); border: 1px solid var(--border-medium);
            color: var(--text-primary); padding: 14px; border-radius: var(--radius-sm);
            font-size: 20px; text-align: center; width: 100%; margin-bottom: 16px;
        }
        .modal input:focus { outline: none; border-color: var(--accent); }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btns button { flex: 1; padding: 12px; border-radius: var(--radius-sm); border: none; cursor: pointer; font-size: 14px; }
        .modal-btns .m-cancel { background: var(--bg-tertiary); color: var(--text-secondary); }
        .modal-btns .m-ok { background: var(--accent); color: white; }

        .toast {
            position: fixed; top: calc(68px + var(--safe-top)); left: 50%;
            transform: translateX(-50%) translateY(-16px);
            background: var(--bg-card); backdrop-filter: blur(16px);
            color: var(--text-primary); padding: 12px 22px; border-radius: 100px;
            font-size: 14px; z-index: 500; opacity: 0; pointer-events: none;
            transition: all 0.3s; border: 1px solid var(--border-medium);
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); border-color: var(--success); }

        .hidden { display: none; }

        @media (min-width: 768px) {
            .dock { max-width: 380px; left: 50%; transform: translateX(-50%); bottom: 20px; border-radius: 100px; border: 1px solid var(--border-subtle); }
            .tpl-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>

<body>
    <div class="loading-screen" id="loading">
        <div class="loading-logo">MONS</div>
        <div class="loading-subtitle">æç®€è®¾è®¡å·¥å…·</div>
        <div class="loading-spinner"></div>
    </div>

    <header class="header">
        <div class="brand">MONS</div>
        <div class="header-actions">
            <button class="btn btn-icon" onclick="undo()" title="æ’¤é”€"><i class="fas fa-undo"></i></button>
            <button class="btn btn-icon" onclick="redo()" title="é‡åš"><i class="fas fa-redo"></i></button>
            <button class="btn btn-icon" onclick="toggleFullscreen()" title="å…¨å±"><i class="fas fa-expand" id="fsIcon"></i></button>
            <button class="btn btn-primary" onclick="showPanel('export')"><i class="fas fa-download"></i> å¯¼å‡º</button>
        </div>
    </header>

    <div class="scene-bar" id="sceneBar"></div>

    <main class="workspace tool-hand" id="workspace">
        <div class="canvas-box" id="canvasBox">
            <canvas id="canvas"></canvas>
        </div>

        <div class="zoom-bar">
            <button class="zoom-btn" onclick="zoomOut()"><i class="fas fa-minus"></i></button>
            <div class="zoom-val" id="zoomVal" onclick="fitToScreen()">50%</div>
            <button class="zoom-btn" onclick="zoomIn()"><i class="fas fa-plus"></i></button>
            <div class="zoom-sep"></div>
            <button class="zoom-btn" onclick="fitToScreen()"><i class="fas fa-compress-arrows-alt"></i></button>
            <button class="zoom-btn" onclick="resetZoom()">1:1</button>
        </div>
    </main>

    <div class="tpl-panel" id="tplPanel">
        <div class="tpl-head">
            <span class="tpl-title" id="tplTitle">é€‰æ‹©æ¨¡æ¿</span>
            <button class="tpl-close" onclick="closeTpl()"><i class="fas fa-times"></i></button>
        </div>
        <div class="tpl-body">
            <div class="tpl-grid" id="tplGrid"></div>
        </div>
    </div>

    <div class="smart-toolbar" id="toolbar">
        <button class="tool-btn" onclick="duplicateObj()" title="å¤åˆ¶"><i class="fas fa-copy"></i></button>
        <button class="tool-btn" onclick="centerObj()" title="å±…ä¸­"><i class="fas fa-crosshairs"></i></button>
        <button class="tool-btn" onclick="bringFwd()" title="ä¸Šç§»"><i class="fas fa-chevron-up"></i></button>
        <button class="tool-btn" onclick="sendBwd()" title="ä¸‹ç§»"><i class="fas fa-chevron-down"></i></button>
        
        <div id="textTools" style="display:none;">
            <div class="tool-sep"></div>
            <select class="font-sel" id="fontSel" onchange="setFont(this.value)">
                <option value="Noto Serif SC">å®‹ä½“</option>
                <option value="Noto Sans SC">é»‘ä½“</option>
            </select>
            <div class="size-box">
                <button class="size-btn" onclick="adjSize(-4)">âˆ’</button>
                <span class="size-val" id="sizeVal" onclick="showSizeModal()">64</span>
                <button class="size-btn" onclick="adjSize(4)">+</button>
            </div>
            <div class="color-row" id="colorRow">
                <div class="color-dot sel" style="background:#1A1A1A" onclick="setColor('#1A1A1A')"></div>
                <div class="color-dot" style="background:#888" onclick="setColor('#888888')"></div>
                <div class="color-dot" style="background:#FFF;border:1px solid #555" onclick="setColor('#FFFFFF')"></div>
                <div class="color-dot picker" onclick="pickColor()"></div>
            </div>
        </div>
        
        <div id="imgTools" style="display:none;">
            <div class="tool-sep"></div>
            <button class="tool-btn" onclick="replaceImg()" title="æ›¿æ¢"><i class="fas fa-exchange-alt"></i></button>
            <button class="tool-btn" onclick="flipImg('x')"><i class="fas fa-arrows-alt-h"></i></button>
            <button class="tool-btn" onclick="flipImg('y')"><i class="fas fa-arrows-alt-v"></i></button>
        </div>
        
        <div class="tool-sep"></div>
        <button class="tool-btn danger" onclick="deleteObj()" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
    </div>

    <div class="dock">
        <div class="dock-item" id="dockHand" onclick="setTool('hand')">
            <i class="fas fa-hand-paper"></i>
            <span>ç”»å¸ƒ</span>
        </div>
        <div class="dock-item" id="dockSelect" onclick="setTool('select')">
            <i class="fas fa-mouse-pointer"></i>
            <span>é€‰æ‹©</span>
        </div>
        <div class="dock-item" id="dockAdd" onclick="toggleAdd()">
            <i class="fas fa-plus"></i>
            <span>æ·»åŠ </span>
            <div class="add-popup" id="addPopup">
                <div class="add-item" onclick="startAddText(event)"><i class="fas fa-font"></i> æ–‡å­—</div>
                <div class="add-item" onclick="triggerImg(event)"><i class="fas fa-image"></i> å›¾ç‰‡</div>
            </div>
        </div>
        <div class="dock-item" onclick="showPanel('canvas')">
            <i class="fas fa-palette"></i>
            <span>èƒŒæ™¯</span>
        </div>
        <div class="dock-item" onclick="showPanel('layers')">
            <i class="fas fa-layer-group"></i>
            <span>å›¾å±‚</span>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="hidePanel()"></div>

    <div class="panel" id="panel-canvas">
        <div class="panel-head">
            <span class="panel-title">ç”»å¸ƒè®¾ç½®</span>
            <button class="panel-close" onclick="hidePanel()"><i class="fas fa-times"></i></button>
        </div>
        <div class="panel-body">
            <div class="section">
                <div class="section-label">èƒŒæ™¯é¢œè‰²</div>
                <div class="bg-grid" id="bgGrid">
                    <div class="bg-item sel" style="background:#F8F6F1" data-c="#F8F6F1"></div>
                    <div class="bg-item" style="background:#FFFFFF" data-c="#FFFFFF"></div>
                    <div class="bg-item" style="background:#FAFAFA" data-c="#FAFAFA"></div>
                    <div class="bg-item" style="background:#E8E4DD" data-c="#E8E4DD"></div>
                    <div class="bg-item" style="background:#1A1A1A" data-c="#1A1A1A"></div>
                    <div class="bg-item" style="background:#0D0D0D" data-c="#0D0D0D"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="panel" id="panel-export">
        <div class="panel-head">
            <span class="panel-title">å¯¼å‡ºå›¾ç‰‡</span>
            <button class="panel-close" onclick="hidePanel()"><i class="fas fa-times"></i></button>
        </div>
        <div class="panel-body">
            <div class="export-list">
                <div class="export-item" onclick="exportImg(1)">
                    <div><h4>å¿«é€Ÿåˆ†äº«</h4><p>å¾®ä¿¡ã€QQ</p></div>
                    <span class="export-badge">1x</span>
                </div>
                <div class="export-item rec" onclick="exportImg(2)">
                    <div><h4>é«˜æ¸…å¯¼å‡º</h4><p>å°çº¢ä¹¦ã€æŠ–éŸ³</p></div>
                    <span class="export-badge">2x æ¨è</span>
                </div>
                <div class="export-item" onclick="exportImg(3)">
                    <div><h4>è¶…æ¸…å¯¼å‡º</h4><p>å°åˆ·ã€æµ·æŠ¥</p></div>
                    <span class="export-badge">3x</span>
                </div>
            </div>
        </div>
    </div>

    <div class="panel" id="panel-layers">
        <div class="panel-head">
            <span class="panel-title">å›¾å±‚</span>
            <button class="panel-close" onclick="hidePanel()"><i class="fas fa-times"></i></button>
        </div>
        <div class="panel-body">
            <div id="layerList"></div>
        </div>
    </div>

    <div class="modal-bg" id="sizeModal">
        <div class="modal">
            <div class="modal-title">è¾“å…¥å­—å·</div>
            <input type="number" id="sizeInput" min="8" max="500" value="64">
            <div class="modal-btns">
                <button class="m-cancel" onclick="closeSizeModal()">å–æ¶ˆ</button>
                <button class="m-ok" onclick="confirmSize()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <input type="file" id="imgInput" class="hidden" accept="image/*" onchange="handleImg(this)">
    <input type="file" id="imgReplace" class="hidden" accept="image/*" onchange="handleReplace(this)">
    <input type="color" id="colorInput" class="hidden" onchange="applyColor(this.value)">
    <div class="toast" id="toast"></div>

    <script>
        // é…ç½®
        const CONFIG = { version: 'V19', defaultBg: '#F8F6F1', initScale: 0.45 };

        // å ä½å›¾
        function placeholder(w, h) {
            return 'data:image/svg+xml,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
                    <defs><linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#E8E4DD"/><stop offset="100%" style="stop-color:#D8D4CD"/>
                    </linearGradient></defs>
                    <rect fill="url(#g)" width="${w}" height="${h}" rx="6"/>
                    <rect x="${w*0.28}" y="${h*0.22}" width="${w*0.44}" height="${h*0.36}" fill="#D0CCC5" rx="4"/>
                    <circle cx="${w*0.4}" cy="${h*0.32}" r="${Math.min(w,h)*0.05}" fill="#C0BBB2"/>
                    <polygon points="${w*0.32},${h*0.5} ${w*0.5},${h*0.36} ${w*0.68},${h*0.5}" fill="#C0BBB2"/>
                    <text x="${w/2}" y="${h*0.72}" text-anchor="middle" fill="#888" font-size="${Math.min(w,h)*0.045}" font-family="sans-serif">ç‚¹å‡»æ›¿æ¢å›¾ç‰‡</text>
                </svg>
            `);
        }

        // åœºæ™¯
        const SCENES = {
            'xhs': { name: 'ğŸ“± å°çº¢ä¹¦å°é¢', w: 1080, h: 1440, tpl: [
                { name: 'å›¾æ–‡æ’ç‰ˆ', bg: '#F8F6F1', obj: [
                    { t:'img', x:0.5, y:0.35, w:0.7, h:0.4 },
                    { t:'txt', txt:'æ ‡é¢˜æ–‡å­—', x:0.5, y:0.72, s:56, f:'Noto Serif SC', c:'#1A1A1A' },
                    { t:'txt', txt:'å‰¯æ ‡é¢˜æè¿°', x:0.5, y:0.82, s:22, f:'Noto Sans SC', c:'#888' }
                ]},
                { name: 'æ‚å¿—é£', bg: '#FFFFFF', obj: [
                    { t:'txt', txt:'MAGAZINE', x:0.5, y:0.06, s:16, f:'Noto Sans SC', c:'#333', sp:500 },
                    { t:'img', x:0.5, y:0.42, w:0.85, h:0.55 },
                    { t:'txt', txt:'å°é¢æ ‡é¢˜', x:0.5, y:0.85, s:42, f:'Noto Serif SC', c:'#1A1A1A' }
                ]},
                { name: 'æ·±è‰²é«˜çº§', bg: '#1A1A1A', obj: [
                    { t:'img', x:0.5, y:0.38, w:0.65, h:0.42 },
                    { t:'txt', txt:'æš—è‰²æ ‡é¢˜', x:0.5, y:0.75, s:48, f:'Noto Serif SC', c:'#FFFFFF' }
                ]}
            ]},
            'dy': { name: 'ğŸ¬ æŠ–éŸ³', w: 1080, h: 1920, tpl: [
                { name: 'è§†é¢‘å°é¢', bg: '#0D0D0D', obj: [
                    { t:'img', x:0.5, y:0.4, w:0.8, h:0.45 },
                    { t:'txt', txt:'è§†é¢‘æ ‡é¢˜', x:0.5, y:0.75, s:52, f:'Noto Sans SC', c:'#FFF' }
                ]},
                { name: 'æ•™ç¨‹ç³»åˆ—', bg: '#FFFFFF', obj: [
                    { t:'txt', txt:'æ•™ç¨‹', x:0.5, y:0.1, s:22, f:'Noto Sans SC', c:'#888' },
                    { t:'img', x:0.5, y:0.4, w:0.85, h:0.42 },
                    { t:'txt', txt:'æŠ€å·§åˆ†äº«', x:0.5, y:0.75, s:44, f:'Noto Serif SC', c:'#1A1A1A' }
                ]}
            ]},
            'wx': { name: 'ğŸ’¬ æœ‹å‹åœˆ', w: 1080, h: 1080, tpl: [
                { name: 'æ–¹å½¢å›¾æ–‡', bg: '#F8F6F1', obj: [
                    { t:'img', x:0.5, y:0.4, w:0.75, h:0.5 },
                    { t:'txt', txt:'æ ‡é¢˜æ–‡å­—', x:0.5, y:0.82, s:32, f:'Noto Serif SC', c:'#1A1A1A' }
                ]},
                { name: 'æ—¥ç­¾å¡ç‰‡', bg: '#FFFFFF', obj: [
                    { t:'txt', txt:'18', x:0.5, y:0.2, s:90, f:'Noto Serif SC', c:'#1A1A1A' },
                    { t:'txt', txt:'January', x:0.5, y:0.32, s:16, f:'Noto Sans SC', c:'#888' },
                    { t:'img', x:0.5, y:0.62, w:0.65, h:0.4 }
                ]}
            ]},
            'ppt': { name: 'ğŸ“Š PPT', w: 1920, h: 1080, tpl: [
                { name: 'æ ‡é¢˜é¡µ', bg: '#FFFFFF', obj: [
                    { t:'txt', txt:'æ¼”ç¤ºæ ‡é¢˜', x:0.5, y:0.4, s:60, f:'Noto Serif SC', c:'#1A1A1A' },
                    { t:'txt', txt:'å‰¯æ ‡é¢˜', x:0.5, y:0.52, s:24, f:'Noto Sans SC', c:'#888' }
                ]}
            ]}
        };

        // çŠ¶æ€
        let scene = 'xhs', cW = 1080, cH = 1440;
        let scale = CONFIG.initScale, panX = 0, panY = 0;
        let tool = 'hand'; // hand | select | add
        let isPan = false, panSX = 0, panSY = 0;

        // Fabric
        const canvas = new fabric.Canvas('canvas', {
            width: cW, height: cH, backgroundColor: CONFIG.defaultBg,
            preserveObjectStacking: true, selection: true
        });

        const box = document.getElementById('canvasBox');
        const ws = document.getElementById('workspace');

        // å†å²
        let hist = [], hIdx = -1;
        function saveHist() {
            if (hIdx < hist.length - 1) hist = hist.slice(0, hIdx + 1);
            hist.push(JSON.stringify(canvas.toJSON(['isPlaceholder'])));
            if (hist.length > 50) hist.shift(); else hIdx++;
            try { localStorage.setItem('mons_draft', hist[hIdx]); localStorage.setItem('mons_scene', scene); } catch(e) {}
        }
        function undo() { if (hIdx > 0) { hIdx--; canvas.loadFromJSON(hist[hIdx], () => canvas.renderAll()); toast('å·²æ’¤é”€'); }}
        function redo() { if (hIdx < hist.length - 1) { hIdx++; canvas.loadFromJSON(hist[hIdx], () => canvas.renderAll()); toast('å·²é‡åš'); }}

        canvas.on('object:added', saveHist);
        canvas.on('object:removed', saveHist);
        canvas.on('object:modified', saveHist);
        canvas.on('selection:created', showToolbar);
        canvas.on('selection:updated', showToolbar);
        canvas.on('selection:cleared', hideToolbar);
        canvas.on('mouse:dblclick', e => { if (e.target?.type === 'image') { canvas.setActiveObject(e.target); replaceImg(); }});

        saveHist();

        // å˜æ¢
        function updateTf() {
            box.style.width = cW + 'px';
            box.style.height = cH + 'px';
            box.style.left = panX + 'px';
            box.style.top = panY + 'px';
            box.style.transform = `scale(${scale})`;
            box.style.transformOrigin = '0 0';
            document.getElementById('zoomVal').textContent = Math.round(scale * 100) + '%';
        }

        function fitToScreen() {
            const wW = ws.clientWidth, wH = ws.clientHeight, pad = 80;
            scale = Math.min((wW - pad * 2) / cW, (wH - pad * 2) / cH, 0.65);
            panX = (wW - cW * scale) / 2;
            panY = (wH - cH * scale) / 2;
            updateTf();
        }

        function resetZoom() {
            scale = 1;
            panX = (ws.clientWidth - cW) / 2;
            panY = (ws.clientHeight - cH) / 2;
            updateTf();
            toast('100%');
        }

        function zoomAt(ns, cx, cy) {
            const os = scale;
            scale = Math.max(0.1, Math.min(3, ns));
            panX = cx - (cx - panX) * (scale / os);
            panY = cy - (cy - panY) * (scale / os);
            updateTf();
        }

        function zoomIn() { zoomAt(scale * 1.25, ws.clientWidth / 2, ws.clientHeight / 2); }
        function zoomOut() { zoomAt(scale / 1.25, ws.clientWidth / 2, ws.clientHeight / 2); }

        // å·¥å…·
        function setTool(t) {
            tool = t;
            hideAdd();
            ws.className = 'workspace tool-' + t;
            document.querySelectorAll('.dock-item').forEach(el => el.classList.remove('active'));
            if (t === 'hand') {
                document.getElementById('dockHand').classList.add('active');
                canvas.discardActiveObject();
                canvas.renderAll();
                hideToolbar();
            } else if (t === 'select') {
                document.getElementById('dockSelect').classList.add('active');
            } else if (t === 'add') {
                document.getElementById('dockAdd').classList.add('active');
                canvas.discardActiveObject();
                canvas.renderAll();
                hideToolbar();
            }
        }

        function toggleAdd() {
            const p = document.getElementById('addPopup');
            if (p.classList.contains('show')) { hideAdd(); }
            else { p.classList.add('show'); }
        }
        function hideAdd() { document.getElementById('addPopup').classList.remove('show'); }

        function startAddText(e) {
            e.stopPropagation();
            hideAdd();
            setTool('add');
            toast('ç‚¹å‡»ç”»å¸ƒæ·»åŠ æ–‡å­—');
        }

        function triggerImg(e) {
            if (e) e.stopPropagation();
            hideAdd();
            document.getElementById('imgInput').click();
        }

        // å·¥ä½œåŒºäº¤äº’
        ws.addEventListener('mousedown', e => {
            if (tool === 'hand' && (e.target === ws || e.target === box)) {
                isPan = true;
                panSX = e.clientX - panX;
                panSY = e.clientY - panY;
                ws.classList.add('dragging');
            }
        });

        ws.addEventListener('click', e => {
            if (tool === 'add' && (e.target.tagName === 'CANVAS' || e.target === box)) {
                const rect = box.getBoundingClientRect();
                const x = (e.clientX - rect.left) / scale;
                const y = (e.clientY - rect.top) / scale;
                addTextAt(x, y);
                setTool('select');
            }
        });

        document.addEventListener('mousemove', e => {
            if (isPan) {
                panX = e.clientX - panSX;
                panY = e.clientY - panSY;
                updateTf();
            }
        });

        document.addEventListener('mouseup', () => {
            isPan = false;
            ws.classList.remove('dragging');
        });

        // è§¦æ‘¸
        let tDist = 0, tScale = 1;
        ws.addEventListener('touchstart', e => {
            if (tool === 'hand' && e.target === ws) {
                if (e.touches.length === 1) {
                    isPan = true;
                    panSX = e.touches[0].clientX - panX;
                    panSY = e.touches[0].clientY - panY;
                } else if (e.touches.length === 2) {
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    tDist = Math.sqrt(dx * dx + dy * dy);
                    tScale = scale;
                }
            }
        }, { passive: true });

        ws.addEventListener('touchmove', e => {
            if (isPan && e.touches.length === 1) {
                panX = e.touches[0].clientX - panSX;
                panY = e.touches[0].clientY - panSY;
                updateTf();
            } else if (e.touches.length === 2) {
                const dx = e.touches[0].clientX - e.touches[1].clientX;
                const dy = e.touches[0].clientY - e.touches[1].clientY;
                const d = Math.sqrt(dx * dx + dy * dy);
                const cx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                const cy = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                zoomAt(tScale * (d / tDist), cx, cy);
            }
        }, { passive: true });

        ws.addEventListener('touchend', () => { isPan = false; });

        // æ»šè½®
        ws.addEventListener('wheel', e => {
            e.preventDefault();
            const rect = ws.getBoundingClientRect();
            const mx = e.clientX - rect.left, my = e.clientY - rect.top;
            zoomAt(scale * (e.deltaY > 0 ? 0.9 : 1.1), mx, my);
        }, { passive: false });

        // åœºæ™¯
        function renderScenes() {
            document.getElementById('sceneBar').innerHTML = Object.entries(SCENES).map(([id, s]) =>
                `<button class="scene-btn ${id === scene ? 'active' : ''}" data-s="${id}" onclick="openTpl('${id}')">${s.name}</button>`
            ).join('');
        }

        function openTpl(id) {
            const s = SCENES[id];
            document.getElementById('tplTitle').textContent = s.name;
            document.getElementById('tplGrid').innerHTML = s.tpl.map((t, i) => {
                const hasImg = t.obj.some(o => o.t === 'img');
                const dark = ['#1A1A1A', '#0D0D0D', '#000'].includes(t.bg);
                return `<div class="tpl-card" onclick="applyTpl('${id}',${i})">
                    <div class="tpl-preview" style="background:${t.bg};color:${dark ? '#fff' : '#1A1A1A'}">
                        ${hasImg ? '<div class="tpl-img">ğŸ–¼ï¸</div>' : ''}
                        <div class="tpl-text">${t.obj.find(o => o.t === 'txt')?.txt || t.name}</div>
                    </div>
                    <div class="tpl-name">${t.name}</div>
                </div>`;
            }).join('');
            document.getElementById('tplPanel').classList.add('show');
        }

        function closeTpl() { document.getElementById('tplPanel').classList.remove('show'); }

        function applyTpl(id, idx) {
            const s = SCENES[id], t = s.tpl[idx];
            scene = id; cW = s.w; cH = s.h;

            document.querySelectorAll('.scene-btn').forEach(b => b.classList.toggle('active', b.dataset.s === id));

            canvas.clear();
            canvas.setDimensions({ width: cW, height: cH });
            canvas.setBackgroundColor(t.bg, canvas.renderAll.bind(canvas));

            t.obj.filter(o => o.t === 'txt').forEach(o => {
                canvas.add(new fabric.Textbox(o.txt, {
                    left: o.x * cW, top: o.y * cH,
                    fontSize: o.s, fontFamily: o.f, fill: o.c,
                    originX: 'center', originY: 'center', textAlign: 'center',
                    width: cW * 0.8, charSpacing: o.sp || 0
                }));
            });

            t.obj.filter(o => o.t === 'img').forEach(o => {
                const iW = Math.round(cW * o.w), iH = Math.round(cH * o.h);
                fabric.Image.fromURL(placeholder(iW, iH), img => {
                    img.set({ left: o.x * cW, top: o.y * cH, originX: 'center', originY: 'center', isPlaceholder: true });
                    canvas.add(img);
                    canvas.sendToBack(img);
                    canvas.renderAll();
                }, { crossOrigin: 'anonymous' });
            });

            closeTpl();
            setTimeout(fitToScreen, 50);
            toast('âœ“ å·²åº”ç”¨æ¨¡æ¿');
        }

        // å·¥å…·æ 
        function showToolbar(e) {
            const obj = e?.target || canvas.getActiveObject();
            if (!obj) return hideToolbar();
            document.getElementById('toolbar').classList.add('show');
            const tt = document.getElementById('textTools'), it = document.getElementById('imgTools');
            if (obj.type === 'textbox') {
                tt.style.display = 'flex'; it.style.display = 'none';
                document.getElementById('sizeVal').textContent = Math.round(obj.fontSize);
                document.getElementById('fontSel').value = obj.fontFamily || 'Noto Serif SC';
            } else if (obj.type === 'image') {
                tt.style.display = 'none'; it.style.display = 'flex';
            } else {
                tt.style.display = 'none'; it.style.display = 'none';
            }
        }
        function hideToolbar() { document.getElementById('toolbar').classList.remove('show'); }

        // æ–‡å­—
        function addTextAt(x, y) {
            canvas.add(new fabric.Textbox('åŒå‡»ç¼–è¾‘', {
                left: x, top: y, fontSize: 56, fontFamily: 'Noto Serif SC', fill: '#1A1A1A',
                originX: 'center', originY: 'center', textAlign: 'center', width: cW * 0.7
            }));
            canvas.setActiveObject(canvas.getObjects().slice(-1)[0]);
            canvas.renderAll();
            toast('âœ“ å·²æ·»åŠ æ–‡å­—');
        }

        function setFont(f) { const o = canvas.getActiveObject(); if (o?.type === 'textbox') { o.set('fontFamily', f); canvas.renderAll(); saveHist(); }}
        function adjSize(d) { const o = canvas.getActiveObject(); if (o?.type === 'textbox') { const s = Math.max(8, Math.min(500, o.fontSize + d)); o.set('fontSize', s); document.getElementById('sizeVal').textContent = s; canvas.renderAll(); saveHist(); }}
        function showSizeModal() { const o = canvas.getActiveObject(); if (o?.type === 'textbox') { document.getElementById('sizeInput').value = Math.round(o.fontSize); document.getElementById('sizeModal').classList.add('show'); }}
        function closeSizeModal() { document.getElementById('sizeModal').classList.remove('show'); }
        function confirmSize() { const o = canvas.getActiveObject(); const v = parseInt(document.getElementById('sizeInput').value); if (o?.type === 'textbox' && v >= 8 && v <= 500) { o.set('fontSize', v); document.getElementById('sizeVal').textContent = v; canvas.renderAll(); saveHist(); } closeSizeModal(); }
        
        function setColor(c) {
            const o = canvas.getActiveObject();
            if (o?.type === 'textbox') {
                o.set('fill', c); canvas.renderAll(); saveHist();
                document.querySelectorAll('#colorRow .color-dot:not(.picker)').forEach(e => {
                    e.classList.toggle('sel', rgbHex(e.style.backgroundColor).toUpperCase() === c.toUpperCase());
                });
            }
        }
        function rgbHex(rgb) { if (!rgb || rgb.startsWith('#')) return rgb; const m = rgb.match(/\d+/g); if (!m) return rgb; return '#' + m.slice(0, 3).map(x => parseInt(x).toString(16).padStart(2, '0')).join(''); }
        function pickColor() { document.getElementById('colorInput').click(); }
        function applyColor(c) { setColor(c); }

        // å›¾ç‰‡
        function handleImg(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 10 * 1024 * 1024) { toast('å›¾ç‰‡è¿‡å¤§'); return; }
            const reader = new FileReader();
            reader.onload = e => {
                fabric.Image.fromURL(e.target.result, img => {
                    if (!img) { toast('åŠ è½½å¤±è´¥'); return; }
                    const maxDim = Math.min(cW, cH) * 0.5;
                    const s = Math.min(maxDim / img.width, maxDim / img.height, 1);
                    img.set({ left: cW / 2, top: cH / 2, originX: 'center', originY: 'center', scaleX: s, scaleY: s });
                    canvas.add(img);
                    canvas.setActiveObject(img);
                    canvas.renderAll();
                    setTool('select');
                    toast('âœ“ å·²æ·»åŠ å›¾ç‰‡');
                }, { crossOrigin: 'anonymous' });
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        function replaceImg() {
            const o = canvas.getActiveObject();
            if (o?.type === 'image') document.getElementById('imgReplace').click();
        }

        function handleReplace(input) {
            const file = input.files[0];
            if (!file) return;
            const o = canvas.getActiveObject();
            if (!o || o.type !== 'image') return;

            const reader = new FileReader();
            reader.onload = e => {
                fabric.Image.fromURL(e.target.result, newImg => {
                    if (!newImg) { toast('åŠ è½½å¤±è´¥'); return; }
                    const oW = o.width * o.scaleX, oH = o.height * o.scaleY;
                    const s = Math.min(oW / newImg.width, oH / newImg.height);
                    newImg.set({ left: o.left, top: o.top, originX: o.originX, originY: o.originY, scaleX: s, scaleY: s, isPlaceholder: false });
                    const idx = canvas.getObjects().indexOf(o);
                    canvas.remove(o);
                    canvas.insertAt(newImg, idx);
                    canvas.setActiveObject(newImg);
                    canvas.renderAll();
                    toast('âœ“ å·²æ›¿æ¢å›¾ç‰‡');
                }, { crossOrigin: 'anonymous' });
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        function flipImg(axis) { const o = canvas.getActiveObject(); if (o?.type === 'image') { o.set(axis === 'x' ? 'flipX' : 'flipY', axis === 'x' ? !o.flipX : !o.flipY); canvas.renderAll(); saveHist(); }}

        // é€šç”¨
        function duplicateObj() { const o = canvas.getActiveObject(); if (!o) return; o.clone(c => { c.set({ left: o.left + 30, top: o.top + 30 }); canvas.add(c); canvas.setActiveObject(c); canvas.renderAll(); toast('âœ“ å·²å¤åˆ¶'); }, ['isPlaceholder']); }
        function deleteObj() { const o = canvas.getActiveObject(); if (!o) return; canvas.remove(o); canvas.renderAll(); toast('âœ“ å·²åˆ é™¤'); }
        function bringFwd() { const o = canvas.getActiveObject(); if (o) { canvas.bringForward(o); canvas.renderAll(); saveHist(); }}
        function sendBwd() { const o = canvas.getActiveObject(); if (o) { canvas.sendBackwards(o); canvas.renderAll(); saveHist(); }}
        function centerObj() { const o = canvas.getActiveObject(); if (o) { o.set({ left: cW / 2, top: cH / 2, originX: 'center', originY: 'center' }); o.setCoords(); canvas.renderAll(); saveHist(); toast('âœ“ å·²å±…ä¸­'); }}

        // èƒŒæ™¯
        document.getElementById('bgGrid').addEventListener('click', e => {
            const item = e.target.closest('.bg-item');
            if (!item) return;
            canvas.setBackgroundColor(item.dataset.c, canvas.renderAll.bind(canvas));
            saveHist();
            document.querySelectorAll('.bg-item').forEach(i => i.classList.remove('sel'));
            item.classList.add('sel');
        });

        // é¢æ¿
        function showPanel(id) { hidePanel(); document.getElementById('overlay').classList.add('show'); document.getElementById(`panel-${id}`).classList.add('show'); if (id === 'layers') updateLayers(); }
        function hidePanel() { document.getElementById('overlay').classList.remove('show'); document.querySelectorAll('.panel').forEach(p => p.classList.remove('show')); }

        function updateLayers() {
            const list = document.getElementById('layerList'), objs = canvas.getObjects();
            if (!objs.length) { list.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px">æš‚æ— å›¾å±‚</div>'; return; }
            list.innerHTML = objs.map((o, i) => {
                const active = canvas.getActiveObject() === o;
                let icon = 'fa-shapes', name = 'å½¢çŠ¶';
                if (o.type === 'textbox') { icon = 'fa-font'; name = o.text.substring(0, 10) + (o.text.length > 10 ? '...' : ''); }
                else if (o.type === 'image') { icon = 'fa-image'; name = o.isPlaceholder ? 'å ä½å›¾' : 'å›¾ç‰‡'; }
                return `<div class="layer-item ${active ? 'active' : ''}" onclick="selLayer(${i})"><i class="fas ${icon} layer-icon"></i><span class="layer-name">${name}</span><button class="layer-del" onclick="event.stopPropagation();delLayer(${i})"><i class="fas fa-trash"></i></button></div>`;
            }).reverse().join('');
        }
        function selLayer(i) { setTool('select'); const o = canvas.getObjects()[i]; if (o) { canvas.setActiveObject(o); canvas.renderAll(); updateLayers(); }}
        function delLayer(i) { const o = canvas.getObjects()[i]; if (o) { canvas.remove(o); canvas.renderAll(); updateLayers(); }}

        // å¯¼å‡º
        function exportImg(m) {
            canvas.discardActiveObject();
            canvas.renderAll();
            const url = canvas.toDataURL({ format: 'jpeg', quality: 0.95, multiplier: m });
            const link = document.createElement('a');
            link.download = `MONS_${scene}_${m}x_${Date.now()}.jpg`;
            link.href = url;
            link.click();
            hidePanel();
            toast('âœ“ å·²å¯¼å‡º', 'success');
        }

        // å…¨å±
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(() => {});
                document.getElementById('fsIcon').className = 'fas fa-compress';
            } else {
                document.exitFullscreen();
                document.getElementById('fsIcon').className = 'fas fa-expand';
            }
        }

        // Toast
        function toast(msg, type = '') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show' + (type ? ' ' + type : '');
            clearTimeout(t._t);
            t._t = setTimeout(() => t.classList.remove('show'), 2000);
        }

        // å¿«æ·é”®
        document.addEventListener('keydown', e => {
            if (e.target.matches('input, textarea')) return;
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) { e.preventDefault(); undo(); }
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) { e.preventDefault(); redo(); }
            if (e.key === 'Delete' || e.key === 'Backspace') { if (canvas.getActiveObject()) { e.preventDefault(); deleteObj(); }}
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') { e.preventDefault(); duplicateObj(); }
            if (e.key === 'Escape') { closeTpl(); hidePanel(); closeSizeModal(); hideAdd(); setTool('hand'); canvas.discardActiveObject(); canvas.renderAll(); }
            if ((e.ctrlKey || e.metaKey) && e.key === '0') { e.preventDefault(); fitToScreen(); }
            if (e.key === 'v' || e.key === 'V') { setTool('select'); }
            if (e.key === 'h' || e.key === 'H') { setTool('hand'); }
        });

        window.addEventListener('resize', fitToScreen);
        document.addEventListener('click', e => { if (!e.target.closest('#dockAdd')) hideAdd(); });

        // åˆå§‹åŒ–
        renderScenes();
        setTool('hand');

        document.fonts.ready.then(() => {
            setTimeout(() => {
                document.getElementById('loading').classList.add('hide');
                try {
                    const sc = localStorage.getItem('mons_scene');
                    if (sc && SCENES[sc]) {
                        scene = sc;
                        cW = SCENES[sc].w;
                        cH = SCENES[sc].h;
                        canvas.setDimensions({ width: cW, height: cH });
                        renderScenes();
                    }
                    const draft = localStorage.getItem('mons_draft');
                    if (draft) {
                        canvas.loadFromJSON(draft, () => { canvas.renderAll(); fitToScreen(); });
                    } else {
                        applyTpl('xhs', 0);
                    }
                } catch(e) { applyTpl('xhs', 0); }
            }, 400);
        });

        setTimeout(() => { document.getElementById('loading').classList.add('hide'); applyTpl('xhs', 0); }, 4000);

        console.log(`ğŸ”ï¸ MONS ${CONFIG.version}`);
    </script>
</body>
</html>
